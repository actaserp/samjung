<html layout:decorate="~{layout_page}">

<th:block layout:fragment="content">
  <div class="layout-contents">
    <div class="page-title-wrap">
      <div class="left">
        <h2>외주발주현황</h2>
        <a title="북마크" class="bookmark toggle">
          내 메뉴
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
        <li>발주관리</li>
        <li>외주발주현황</li>
      </ul>
    </div>

    <section class="section">
      <div class="section-top">
        <div class="search-wrap">
          <input type="hidden" id="spjangcdHidden" name="spjangcd"/>
          <dl>
            <dt>
              <label for="cboDateKind">
                검색 구분<span class="eq"></span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <select id="cboDateKind" name="cboDateKind">
                  <option value="sales">발주일</option>
                  <option value="delivery">납기일</option>
                </select>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              조회기간<span class="eq">*</span>
            </dt>
            <dd>
              <ul class="date-box">
                <li>
                  <input type="date" id="srchStartDt" name="srchStartDt">
                  <label for="srchStartDt" class="hide">시작일</label>
                </li>
                <li>
                  <input type="date" id="srchEndDt" name="srchEndDt">
                  <label for="srchEndDt" class="hide">종료일</label>
                </li>
              </ul>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="txtClt">
                발주처
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <input id="txtClt" name="txtClt" placeholder="발주처"/>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="txtActnm">
                현장명
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <input id="txtActnm" name="txtActnm" placeholder="현장명"/>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="검색" id="btnSearch">
                  <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                  <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                  검색
                </a>
              </li>
            </dd>
          </dl>
        </div>
      </div>
      <div class="container-fluid">
        <div id="theGrid" style="height: 730px;"></div>
      </div>
    </section>
  </div>
  </div>

</th:block>

<th:block layout:fragment="scripts">
  <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
  <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
  <th:block th:replace="/common/popup_company_purchase :: popup_company_Purchase"></th:block>
  <th:block th:replace="/common/popup_projcet :: popup_projcet"></th:block>
  <th:block th:replace="/common/popup_staff :: popup_staff"></th:block>
  <th:block th:replace="/common/popup_actnm :: popup_actnm"></th:block>
  <th:block th:replace="/common/popup_part :: popup_part"></th:block>
  <script type="text/javascript">
    const ProductInputHandler = {
      bind: function ({rowSelector, $content}) {
        const $row = $(rowSelector);

        // 숫자 포맷 적용 대상 필드들
        const formatFields = [
          'input[name^="pqty_"]',   //수량
          'input[name^="puamt_"]',  //단가
          'input[name^="pamt_"]'    //금액
        ];

        formatFields.forEach(selector => {
          $row.find(selector).off('keyup').on('keyup', function () {
            formatNumberInput($(this).val(), this);
          });

          $row.find(selector).each(function () {
            if ($(this).val()) {
              formatNumberInput($(this).val(), this);
            }
          });
        });

        // 계산 이벤트 바인딩
        $row.find('input[name^="pqty_"], input[name^="puamt_"]').off('input change keyup').on('input change keyup', function () {
          calculateAmount({row: $row});
        });

        $row.find('input[name^="pamt_"]').off('input').on('input', function () {
          $row.data('totalEdited', true); // 자동계산 안 되도록 표시
        });

        // 제품 검색 기능 (기존 그대로 유지)
        const $input = $row.find('input[name^="txtPname_"]');
        const $id = $row.find('input[name^="Material_id_"]');
        const $code = $row.find('input[name^="product_code_"]');
        const $group = $row.find('input[name^="MaterialGroupName_"]');
        const $next = $row.find('input[name^="quantity_"]');

        $input.on('input', function () {
          const value = $(this).val().trim();

          if (value === '') {
            $id.val('');
            $code.val('');
            $group.val('');
          }
        });

        function set(item) {
          $input.val(item.Name);
          $id.val(item.id);
          $code.val(item.Code);
          $group.val(item.group_name);
          tryShowBaljuPrice($row);

          setTimeout(() => {
            $next.focus().select();
          }, 10);
        }

        $input.off('keydown').on('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const keyword = $input.val().trim();

            if (!keyword) return showPopup();

            $.get('/api/popup/search_part', {PART_NM: keyword}, function (res) {
              if (res.data?.length === 1) {
                set(res.data[0]);
              } else {
                showPopup();
              }
            });

            function showPopup() {
              const pop = new PopPart();

              pop.show(set, keyword);

              setTimeout(() => {
                if (pop.$keyword) {
                  pop.$keyword.val(keyword);
                  if (pop.$cboMaterialGrp) pop.$cboMaterialGrp.val('');
                  pop.searchDataBind();
                }
              }, 100);
            }
          }
        });
      }
    };

    class BaljuOrderPage {
      constructor() {
        this.url = '/api/balju/balju_list';
        this.grid = null;
        this.$btnEdit = $('#btnEdit');
        this.$btnAddNew = $('#btnAddNew');
        this.$btnMail = $('#btnMail');
        this.spjangcd = $('#spjangcdHidden');
        this.viewData = new wijmo.collections.CollectionView();
        this.init();
      }

      init() {
        let _this = this;
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'project_no', header: '프로젝트번호', width: 120},
            {binding: 'BALJUNUM', header: '주문번호', width: 150, visible: false},
            {binding: 'BALJUSEQ', header: 'seq', width: 150, visible: false},
            {binding: 'CLTNM', header: '발주처', width: 170},
            {binding: 'BALJUDATE', header: '발주일', width: 120, align: 'center'},
            {binding: 'PERNM', header: '현장 PM', width: 100, align: 'center'},
            {binding: 'ACTNM', header: '현장명', width: 170, align: 'center'},
            {binding: 'ichdate', header: '납기일자', width: 120, align: 'center'},
            {binding: 'pname', header: '품명', width: 170, align: 'center'},
            {binding: 'pmapseq', header: '도번', width: 120, align: 'center'},
            {binding: 'punit', header: '단위', width: 70, align: 'center'},
            {binding: 'pqty', header: '수량', width: 60, align: 'right', format: 'n0'},
            {binding: 'puamt', header: '단가', width: 110, align: 'right', format: 'n0'},
            {binding: 'pamt', header: '금액', width: 110, align: 'right',format: 'n0'},
            {binding: 'CHULFLAG', header: '발주처 출고여부', width: 120, align: 'center'},
            {binding: 'CHULDATE', header: '발주처 출고일자', width: 120, align: 'center'},
            {binding: 'CHULPERNM', header: '발주처 출고자', width: 120, align: 'center'},
            {binding: 'facflag', header: '공장 출고 여부', width: 120, align: 'center'},
            {binding: 'FACDATE', header: '공장 출고 일자', width: 120, align: 'center'},
            {binding: 'FACPERNM', header: '공장 출고자', width: 120, align: 'center'},
            {binding: 'hyunflag', header: '현장 확인 여부', width: 120, align: 'center'},
            {binding: 'HYUNDATE', header: '현장 확인 일자', width: 120, align: 'center'},
            {binding: 'HYUNPERNM', header: '현장 확인자', width: 120, align: 'center'},
            {binding: 'remark', header: '비고', width: 150, align: 'center'},
          ],
          itemsSource: this.viewData, // 데이터를 설정할 배열
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = '발주 상세 현황';

        this.grid.hostElement.addEventListener('dblclick', function (e) {
          let items = _this.grid.selectedItems;
          if (items.length === 0) {
            return false;
          }
          _this.$btnEdit.trigger('click');
        });

        // 엔터키 검색
        $('#keyword').on('keypress', function (e) {
          if (e.keyCode === 13) {
            _this.searchMainData();
          }
        });

      }//init

      searchMainData() {
        let _this = this;
        let url = this.url + '/read';

        console.log('searchMainData');
        const sessionDate = sessionStorage.getItem("sessionIchDate");
        const sessionAN = sessionStorage.getItem("sessionAN");
        const tabAction = sessionStorage.getItem("tabAction");

        if (sessionDate && /^\d{8}$/.test(sessionDate)) {
          const formattedDate = sessionDate.replace(/^(\d{4})(\d{2})(\d{2})$/, '$1-$2-$3');
          $("#srchStartDt").val(formattedDate);
          $("#srchEndDt").val(formattedDate);
        }
        if (sessionAN) {
          $("#txtActnm").val(sessionAN);
        }

        if (tabAction === "toggle") {
          $("#cboDateKind").val("delivery").trigger("change"); // 필요 시 change 이벤트
        }

        let date_kind = $('#cboDateKind').val();  //발주구분
        let start = $('#srchStartDt').val();  //시작일
        let end = $('#srchEndDt').val();      //종료일
        let txtClt = $('#txtClt').val(); //발주처
        let txtActnm = $('#txtActnm').val(); //현잔 명

        let data = {
          'clt': txtClt,
          'actnm': txtActnm,
          'date_kind': date_kind,
          'start': start,
          'end': end,
          'action': 'read'
        };

        let fnsuccess = function (result) {
          if (result && Array.isArray(result.data)) {
            _this.viewData = new wijmo.collections.CollectionView(result.data, {
              sortDescriptions: [
                {property: 'BALJUNUM', ascending: true},
                {property: 'BALJUSEQ', ascending: true}
              ],
              groupDescriptions: [
                new wijmo.collections.PropertyGroupDescription('BALJUNUM', item => {
                  return `주문번호: ${item.BALJUNUM} / 발주처: ${item.ACTNM} / 총금액: ${item.TOTAL_PAMT?.toLocaleString() ?? 0}원`;
                })
              ]
            });

            _this.grid.itemsSource = _this.viewData;
          }
        };
        AjaxUtil.getAsyncData(url, data, fnsuccess);

        sessionStorage.removeItem("tabAction");
        sessionStorage.removeItem("sessionDate");
        sessionStorage.removeItem("sessionPN");
        sessionStorage.removeItem("sessionAN");
        sessionStorage.removeItem("sessionIchDate");
      }
    }

    let page = null;
    var picker = new ax5.ui.picker();

    $(document).ready(function (e) {

      const spjangcd = sessionStorage.getItem('spjangcd');
      if (spjangcd) {
        $('#spjangcdHidden').val(spjangcd);  // hidden input이 있어야 함
      }

      page = new BaljuOrderPage();

      $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
      $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

      page.searchMainData();

      // 검색
      $('#btnSearch').click(function (e) {
        page.searchMainData();
      });

    });
  </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>