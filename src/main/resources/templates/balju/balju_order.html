<html layout:decorate="~{layout_page}">

<th:block layout:fragment="content">
  <div class="layout-contents">
    <div class="page-title-wrap">
      <div class="left">
        <h2>ì™¸ì£¼ë°œì£¼ë“±ë¡</h2>
        <a title="ë¶ë§ˆí¬" class="bookmark toggle">
          ë‚´ ë©”ë‰´
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ë°œì£¼ê´€ë¦¬</li>
        <li>ì™¸ì£¼ë°œì£¼ë“±ë¡</li>
      </ul>
    </div>

    <section class="section">
      <div class="section-top">
        <div class="search-wrap">
          <input type="hidden" id="spjangcdHidden" name="spjangcd"/>
          <dl>
            <dt>
              <label for="cboDateKind">
                ê²€ìƒ‰ êµ¬ë¶„<span class="eq"></span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <select id="cboDateKind" name="cboDateKind">
                  <option value="sales">ë°œì£¼ì¼</option>
                  <option value="delivery">ë‚©ê¸°ì¼</option>
                </select>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              ì¡°íšŒê¸°ê°„<span class="eq">*</span>
            </dt>
            <dd>
              <ul class="date-box">
                <li>
                  <input type="date" id="srchStartDt" name="srchStartDt">
                  <label for="srchStartDt" class="hide">ì‹œì‘ì¼</label>
                </li>
                <li>
                  <input type="date" id="srchEndDt" name="srchEndDt">
                  <label for="srchEndDt" class="hide">ì¢…ë£Œì¼</label>
                </li>
              </ul>
            </dd>
          </dl>

          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                  <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                  ê²€ìƒ‰
                </a>
              </li>
            </dd>
          </dl>
        </div>
        <div class="button-wrap">
          <ul>
            <li>
              <a class="btn btn-excell" title="ì™¸ì£¼ë°œì£¼ì„œ" id="btnbaljuPrinted">
                <img src="/images/icon/printer.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                ì™¸ì£¼ë°œì£¼ì„œ
              </a>
            </li>
            <li>
              <a class="btn btn-excell" title="êµ¬ë§¤í’ˆì˜ì„œ" id="btnPrinted">
                <img src="/images/icon/printer.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                êµ¬ë§¤í’ˆì˜ì„œ
              </a>
            </li>
            <li>
              <a class="btn btn-excell" title="ë“±ë¡" id="btnAddNew">
                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                ë“±ë¡
              </a>
            </li>
            <li>
              <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete">
                <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜">
                ì‚­ì œ
              </a>
            </li>
            <li>
              <a class="btn btn-edit" title="ìˆ˜ì •" id="btnEdit">
                <img src="/images/icon/ico-edit.svg" alt="ìˆ˜ì • ì•„ì´ì½˜">
                ìˆ˜ì •
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="container-fluid">
        <div id="theGrid" style="height: 730px;"></div>
      </div>
    </section>
  </div>
  </div>

  <script type="text/x-tmpl" id="baljuTemplate">
    <style>

  /* ì•„ì´í…œ í…Œì´ë¸” ì „ì²´ ì„¤ì • */
  .item-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    margin-top: 10px;
  }

  /* í—¤ë” ì…€ ìŠ¤íƒ€ì¼ */
  .item-table th {
    background-color: #EDEFF5;
    text-align: center;
    font-weight: bold;
    padding: 8px;
    border: 1px solid #ccc;
  }

  /* ë°”ë”” ì…€ ìŠ¤íƒ€ì¼ */
  .item-table td {
    padding: 6px;
    text-align: center;
    border: 1px solid #ccc;
  }

  /* ì…ë ¥ í•„ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
  .item-table input {
    width: 100%;
    box-sizing: border-box;
    padding: 4px;
  }

  /* í’ˆëª© & ë¹„ê³  ì™¼ìª½ ì •ë ¬ */
  .item-table td:first-child,
  .item-table td:nth-child(6) {
    text-align: left;
  }

  /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .item-table .btn.in_btn {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 30px;
    height: 30px;
    border-radius: 4px;
    padding: 0;
    border: 1px solid #B3B3B3;
    background-color: #fff;
    cursor: pointer;
    transition: background-color 0.2s;
    line-height: 0;
  }

  /* + ë²„íŠ¼ ì „ìš© ìŠ¤íƒ€ì¼ */
  .item-table .btn.in_btn.plus img {
    width: 10px;
    height: 10px;
    display: block;
  }

  /* ê³µí†µ ì•„ì´ì½˜ ë²„íŠ¼ ì´ë¯¸ì§€ (ì‚­ì œ, ê²€ìƒ‰ í¬í•¨) */
  .item-table .btn.in_btn img {
    width: 12px;
    height: 12px;
    display: block;
    margin-right:2px;
  }
  .input-with-button {
    display: flex;
    gap: 4px; /* ë²„íŠ¼ê³¼ input ì‚¬ì´ ì—¬ë°± */
    align-items: center;
  }

  .input-with-button input {
    flex: 1; /* ë‚˜ë¨¸ì§€ ì˜ì—­ ì°¨ì§€ */
    min-width: 0;
    padding: 4px;
  }

  .input-with-button .btn.in_btn {
    flex-shrink: 0;
  }
  .content_wrap.popup {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .table-wrap {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px;
  }
  .popup-button {
    flex-shrink: 0;
    padding: 10px;
    background: #fff;
    border-top: 1px solid #ddd;
  }
  .input-with-checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .input-with-checkbox input[type="number"] {
    flex: 1;
    min-width: 0;
    padding: 4px;
  }

  .input-with-checkbox input[type="checkbox"] {
    flex-shrink: 0;
    width: 18px;
    height: 18px;
  }

  .excel-write-table {

  }
  .excel-write-table th {
    text-align: center;
  }
  .excel-write-table tr {
    height: 35px;
  }
  .excel-write-table td input {
    padding: 8px;
    border-radius: 4px;
    height: 33px;
  }

  .input-with-button {
    display: flex;
    gap: 4px;
    align-items: center;
  }
  .small-btn {
    width: 30px;
    height: 30px;
    padding: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .small-btn img {
  margin-right: 4px;
  }
  .write-table {
    table-layout: fixed;
    width: 100%;
  }
  .write-table th {
    white-space: normal;
    word-break: break-word;
    padding: 6px 8px;
  }
  .half-input-group {
    display: flex;
    gap: 4px;
  }
  .half-input-group input {
    width: calc(50% - 2px); /* gap 4pxì´ë‹ˆê¹Œ ë‚˜ëˆ ì„œ ë¹¼ì¤Œ */
    min-width: 0;
    box-sizing: border-box;
  }
    .item-table tbody tr.from-bom {
    background-color: #fff9c4; /* ì—°í•œ ë…¸ë‘ */
  }
</style>
    <div class="content_wrap popup" id="div_excel_upload">
    <div class="table-wrap">
      <form id="baljuForm">
       <table class="write-table excel-write-table">
          <colgroup>
            <col style="width: 15%;">
            <col style="width: 35%;">
            <col style="width: 15%;">
            <col style="width: 35%;">
          </colgroup>
          <caption>ë°œì£¼ë“±ë¡ í…Œì´ë¸”</caption>
          <input type="hidden" id="spjangcdHidden" name="spjangcd"/>
          <input type="hidden" id="BALJUNUM" name="BALJUNUM"/>
          <tbody>
          <!--<tr>
            <th style="text-align: center">
              <label for="baljudate">ë°œì£¼ì¼</label>
            </th>
           <td>
              <input type="date" id="baljudate" name="baljudate">
            </td>
          </tr>-->
          <tr>
            <th style="text-align: center">
              <label for="procd">í”„ë¡œì íŠ¸ ë²ˆí˜¸*</label>
            </th>
            <td>
              <div class="input-with-button">
              <input id="procd" name="procd" type="hidden">
              <input id="eco_no" name="eco_no" type="hidden">
              <input id="project_no" name="project_no" type="text" placeholder="ê²€ìƒ‰ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”">
                <input class="form-control2" type="hidden" id="PROJECT_NM" name="PROJECT_NM"/>
                <a class="btn btn-delete small-btn" title="í”„ë¡œì íŠ¸ê²€ìƒ‰" id="btnProjectSearch">
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                </a>
              </div>
            </td>
            <th style="text-align: center">
              <label for="ichdate">ë‚©ê¸° ì¼ì</label>
            </th>`
            <td>
              <input type="date" id="ichdate" name="ichdate">
            </td>
          </tr>
          <tr>
            <th style="text-align: center">
              <label for="pernm">í˜„ì¥ PM</label>
            </th>
            <td>
              <div class="half-input-group">
                <input type="hidden" id="pernm_rspcdcd" name="pernm_rspcdcd">
                <input type="text" id="pernm_rspcd" name="pernm_rspcd" placeholder="í˜„ì¥ PM ì§ìœ„">
                <input type="text" id="pernm" name="pernm" placeholder="í˜„ì¥ PM">
                <input type="hidden" id="pernmcd" name="pernmcd">
                <a class="btn btn-delete small-btn" title="í˜„ì¥pmê²€ìƒ‰" id="btnPernmSearch">
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                </a>
              </div>
            </td>
            <th style="text-align: center">
              <label for="pertelno">ì—°ë½ì²˜</label>
            </th>
            <td>
              <input type="text" id="pertelno" name="pertelno" placeholder="í˜„ì¥ PM ì—°ë½ì²˜">
            </td>
          </tr>
          <tr>
            <th style="text-align: center">
              <label for="actnm">í˜„ì¥ëª…</label>
            </th>
            <td>
            <div class="input-with-button">
              <input type="text" id="actnm" name="actnm" placeholder="í˜„ì¥ëª…">
              <input type="hidden" id="actcd" name="actcd" >
              <a class="btn btn-delete small-btn" title="í˜„ì¥ê²€ìƒ‰" id="btnactnmSearch">
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                </a>
                </div>
            </td>
            <th style="text-align: center">
              <label for="actaddress">í˜„ì¥ ì£¼ì†Œ</label>
            </th>
            <td>
              <input type="text" id="actaddress" name="actaddress" placeholder="í˜„ì¥ ì£¼ì†Œ">
            </td>
          </tr>
          <tr>
            <th style="text-align: center">
              <label for="cboCompany">ë°œì£¼ì²˜*</label>
            </th>
            <td>
              <div class="input-with-button">
                <input type="hidden" id="cltcd" name="cltcd" >
                <input class="form-control2" type="text" id="CompanyName" name="CompanyName"
                       placeholder="ê²€ìƒ‰ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ êµ¬ë§¤ì²˜ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”" readonly/>
                <a class="btn btn-delete small-btn" title="êµ¬ë§¤ì²˜ê²€ìƒ‰" id="btnCompanySearch">
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                </a>
              </div>
            </td>
            <th style="text-align: center">
              <label for="cltpernm">ë‹´ë‹¹ì</label>
            </th>
              <td class="half-input-group">
                <div class="input-with-button">
                <input type="hidden" id="cltjikcd" name="cltjikcd">
              <input type="text" id="cltjik" name="cltjik"  placeholder="ë°œì£¼ì²˜ ë‹´ë‹¹ ì§ìœ„">
                  <input type="text" id="cltpernm" name="cltpernm" placeholder="ë°œì£¼ì²˜ ë‹´ë‹¹ì">
                  <input type="hidden" id="cbocltcd" name="cbocltcd" >
                </div>
            </td>
          </tr>
          <tr>
            <th style="text-align: center">
              <label for="clttelno">ì—°ë½ì²˜</label>
            </th>
            <td>
              <input type="text" id="clttelno" name="clttelno" placeholder="ë°œì£¼ì²˜ ë‹´ë‹¹ ì—°ë½ì²˜">
            </td>
            <th style="text-align: center">
              <label for="cltemail">ì´ë©”ì¼</label>
            </th>
            <td>
              <input type="text" id="cltemail" name="cltemail" placeholder="ë°œì£¼ë‹´ë‹¹ ì´ë©”ì¼">
            </td>
          </tr>
          <tr>
            <th style="text-align: center">
              <label for="remark01">íŠ¹ê¸°ì‚¬í•­</label>
            </th>
            <td colspan="6">
              <input type="text" id="remark01" name="remark01" placeholder="1. íŠ¹ì´ì‚¬í•­" style="width:100%;margin-bottom: 2px;">
              <input type="text" id="remark02" name="remark02" placeholder="2. íŠ¹ì´ì‚¬í•­" style="width:100%;margin-bottom: 2px;">
              <input type="text" id="remark03" name="remark03" placeholder="3. íŠ¹ì´ì‚¬í•­" style="width:100%">
            </td>
          </tr>
        </table>

        <table class="item-table">

            <colgroup>
              <col style="width: 7%">
              <col style="width: 18%">
              <col style="width: 16%">
              <col style="width: 6%">
              <col style="width: 6%">
              <col style="width: 12%">
              <col style="width: 12%">
              <col style="width: 12%">
              <col style="width: 12%">
              <col style="width: 4%">
            </colgroup>
            <thead>
              <tr id="itemHeaderRow">
                <th>í’ˆëª©ì½”ë“œ</th>
                <th>í’ˆëª…</th>
                <th>ê·œê²©</th>
                <th>ë‹¨ìœ„</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ë‹¨ê°€</th>
                <th>ê¸ˆì•¡</th>
                <th>ë„ë²ˆ</th>
                <th>ë¹„ê³ </th>
                <th>
                  <a class="btn in_btn plus" id="addRemark" title="ì¶”ê°€">
                    <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜" />
                  </a>
                </th>
              </tr>
            </thead>
            <tr class="item-template-row" style="display: none;">
              <td>
                <input type="text" name="pcode" placeholder="í’ˆëª©ì½”ë“œ" readonly />
                <input type="hidden" name="bpid" />
                <input type="hidden" name="isbom" />
                <input type="hidden" name="BALJUSEQ" />
                <input type="hidden" name="chulflag" />
                <input type="hidden" name="facflag" />
                <input type="hidden" name="hyunflag" />
              </td>
              <td>
                <div class="input-with-button">
                  <input type="text" name="txtPname" placeholder="ì…ë ¥ í›„ ì—”í„°" autocomplete="off" />
                  <a class="btn in_btn" title="í’ˆëª© ê²€ìƒ‰" id="btnProductSearch" >
                    <img src="/images/icon/btn-srch-black.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜" />
                  </a>
                </div>
              </td>
              <td><input type="text" name="psize" placeholder="ê·œê²©" /></td>
              <td><input type="text" name="punit" placeholder="ë‹¨ìœ„" /></td>
              <td><input type="text" name="pqty" placeholder="ìˆ˜ëŸ‰" /></td>
              <td><input type="text" name="puamt" min="0" placeholder="ë‹¨ê°€"/></td>
              <td><input type="text" name="pamt" placeholder="ê¸ˆì•¡"/></td>
              <td><input type="text" name="pmapseq" placeholder="ë„ë²ˆ"/></td>
              <td><input type="text" name="remark" placeholder="ë¹„ê³ "/></td>
              <td class="al_c item_border">
                <a class="btn in_btn" title="í–‰ ì‚­ì œ">
                  <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜" />
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </form>
    </div>
    <div class="popup-button">
      <button type="button" class="btn-popup y_write_auth" id="btnPopBaljuSave" style="height: 40px;">ì €ì¥(Ctrl + S)</button>
      <button type="button" class="btn-popup" id="modal-close-button" style="height: 40px;">ë‹«ê¸°</button>
    </div>
  </script>

</th:block>

<th:block layout:fragment="scripts">
  <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
  <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
  <th:block th:replace="/common/popup_company_purchase :: popup_company_Purchase"></th:block>
  <th:block th:replace="/common/popup_projcet :: popup_projcet"></th:block>
  <th:block th:replace="/common/popup_staff :: popup_staff"></th:block>
  <th:block th:replace="/common/popup_actnm :: popup_actnm"></th:block>
  <th:block th:replace="/common/popup_part :: popup_part"></th:block>
  <script type="text/javascript">
    const ProductInputHandler = {
      bind: function ({rowSelector, $content}) {
        const $row = $(rowSelector);

        // ìˆ«ì í¬ë§· ì ìš© ëŒ€ìƒ í•„ë“œë“¤
        const formatFields = [
          'input[name^="pqty_"]',   //ìˆ˜ëŸ‰
          'input[name^="puamt_"]',  //ë‹¨ê°€
          'input[name^="pamt_"]'    //ê¸ˆì•¡
        ];

        formatFields.forEach(selector => {
          $row.find(selector).off('keyup').on('keyup', function () {
            formatNumberInput($(this).val(), this);
          });

          $row.find(selector).each(function () {
            if ($(this).val()) {
              formatNumberInput($(this).val(), this);
            }
          });
        });

        // ê³„ì‚° ì´ë²¤íŠ¸ ë°”ì¸ë”©
        $row.find('input[name^="pqty_"], input[name^="puamt_"]').off('input change keyup').on('input change keyup', function () {
          calculateAmount({ row: $row });
        });

        $row.find('input[name^="pamt_"]').off('input').on('input', function () {
          $row.data('totalEdited', true); // ìë™ê³„ì‚° ì•ˆ ë˜ë„ë¡ í‘œì‹œ
        });

        // ì œí’ˆ ê²€ìƒ‰ ê¸°ëŠ¥ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ ìœ ì§€)
        const $input = $row.find('input[name^="txtPname_"]');
        const $id = $row.find('input[name^="Material_id_"]');
        const $code = $row.find('input[name^="product_code_"]');
        const $group = $row.find('input[name^="MaterialGroupName_"]');
        const $next = $row.find('input[name^="quantity_"]');

        $input.on('input', function () {
          const value = $(this).val().trim();

          if (value === '') {
            $id.val('');
            $code.val('');
            $group.val('');
          }
        });

        function set(item) {
          $input.val(item.Name);
          $id.val(item.id);
          $code.val(item.Code);
          $group.val(item.group_name);
          tryShowBaljuPrice($row);

          setTimeout(() => {
            $next.focus().select();
          }, 10);
        }

        $input.off('keydown').on('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const keyword = $input.val().trim();

            if (!keyword) return showPopup();

            $.get('/api/popup/search_part', { PART_NM: keyword }, function (res) {
              if (res.data?.length === 1) {
                set(res.data[0]);
              } else {
                showPopup();
              }
            });

            function showPopup() {
              const pop = new PopPart();

              pop.show(set, keyword);

              setTimeout(() => {
                if (pop.$keyword) {
                  pop.$keyword.val(keyword);
                  if (pop.$cboMaterialGrp) pop.$cboMaterialGrp.val('');
                  pop.searchDataBind();
                }
              }, 100);
            }
          }
        });
      }
    };
    class BaljuOrderPage {
      constructor() {
        this.url = '/api/balju/balju_order';
        this.grid = null;
        this.$btnEdit = $('#btnEdit');
        this.$btnAddNew = $('#btnAddNew');
        this.$btnMail = $('#btnMail');
        this.spjangcd = $('#spjangcdHidden');
        this.viewData = new wijmo.collections.CollectionView();
        this.init();
      }

      init() {
        let _this = this;
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'BALJUNUM', header: 'ì£¼ë¬¸ë²ˆí˜¸', width: 150, visible: false},
            {binding: 'ACTNM', header: 'ë°œì£¼ì²˜', width: 130},
            {binding: 'BALJUDATE', header: 'ë°œì£¼ì¼', width: 120, align: 'center'},
            {binding: 'project_no', header: 'í”„ë¡œì íŠ¸ë²ˆí˜¸', width: 120 },
            {binding: 'PERNM', header: 'í˜„ì¥ PM', width: 100, align: 'center'},
            {binding: 'ACTNM', header: 'í˜„ì¥ëª…', width: 170, align: 'center'},
            {binding: 'ichdate', header: 'ë‚©ê¸°ì¼ì', width: 120, align: 'right'},
            {binding: 'pname', header: 'í’ˆëª…', width: 120, align: 'right'},
            {binding: 'punit', header: 'ë‹¨ìœ„', width: 100, align: 'right', format: 'n0'},
            {binding: 'pqty', header: 'ìˆ˜ëŸ‰', width: 80, align: 'right', format: 'n0'},
            {binding: 'puamt', header: 'ë‹¨ê°€', width: 100, align: 'right',format: 'n0'},
            {binding: 'pamt', header: 'ê¸ˆì•¡', width: 100, align: 'right'},
            {binding: 'pmapseq', header: 'ë„ë²ˆ', width: 100, align: 'right'},
            {binding: 'chulflag', header: 'ë°œì£¼ì²˜ì¶œê³ ì—¬ë¶€', width: 120, align: 'center'},
            {binding: 'facflag', header: 'ê³µì¥ì¶œê³ ì—¬ë¶€', width: 120, align: 'center'},
            {binding: 'hyunflag', header: 'í˜„ì¥í™•ì¸ì—¬ë¶€', width: 120, align: 'center'},
            {binding: 'remark', header: 'ë¹„ê³ ', width: 150, align: 'center'},
          ],
          itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = 'ë°œì£¼ ë“±ë¡';

        this.grid.hostElement.addEventListener('dblclick', function (e) {
          let items = _this.grid.selectedItems;
          if (items.length === 0) {
            return false;
          }
          _this.$btnEdit.trigger('click');
        });

        let nowDate = CommonUtil.getYYYYMMDD();
        let ichdate = CommonUtil.getYYYYMMDD(10);

        //ë°œì£¼ë“±ë¡ í´ë¦­
        this.$btnAddNew.click(function (e) {
          let defaultData = {
            id: '',
            mode: 'new',
            baljudate: nowDate,
            ichdate: ichdate,
            State: 'draft',
            spjangcd: _this.spjangcd.val()
          };
          _this.showBaljuForm(defaultData);
        });

        // ë°œì£¼ ìˆ˜ì • í´ë¦­
        this.$btnEdit.click(function (e) {
          let selectedItems = _this.grid.selectedItems;

          if (selectedItems.length === 1) {

            let selected = selectedItems[0];

            let data = {
              id: selected.BALJUNUM,
              action: 'detail'
            };
            // console.info("ê°€ì§€ê³  ê°€ëŠ” ë°ì´í„°", data);
            let fnsuccess = function (result) {
              if (!result || !result.data) {
                Alert.alert('ì˜¤ë¥˜', 'ìƒì„¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }

              result.data['mode'] = 'edit';
              _this.showBaljuForm(result.data);
              // console.log("íŒì—… ì‘ë‹µ JSON:", JSON.stringify(result.data, null, 2));
            };
            AjaxUtil.getAsyncData(_this.url + '/detail', data, fnsuccess);
          } else if (items.length > 1) {
            Alert.alert('', 'ë°ì´í„°ë¥¼ í•˜ë‚˜ë§Œ ì„ íƒí•˜ì„¸ìš”.');
          } else {
            Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          }

        });

        // ì‚­ì œ ë²„íŠ¼
        $('#btnDelete').click(function (e) {
          let items = _this.grid.selectedItems;
          if (items.length > 0) {
            //console.log('ğŸ” ì‚­ì œ ëŒ€ìƒ ë°ì´í„°:', items);
            let id = items[0].BALJUNUM;
            const { chulflag, facflag, hyunflag } = items[0];
            const isDraft = chulflag === "ë¯¸ì¶œê³ " && facflag === "ë¯¸ì¶œê³ " && hyunflag === "ë¯¸í™•ì¸";

            if (!isDraft) {
              Alert.alert('', 'ë¯¸ì¶œê³  , ë¯¸í™•ì¸ ì‹œì—ë§Œ ì‚­ì œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              return;
            }
            Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
              function () {
                _this.deleteBalJuData(id);
              },
              function () {}
            );
          } else {
            Alert.alert('', 'ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', function () {
              $(this).focus();
            });
          }
        });

        // ì—”í„°í‚¤ ê²€ìƒ‰
        $('#keyword').on('keypress', function (e) {
          if (e.keyCode === 13) {
            _this.searchMainData();
          }
        });

        $('#btnPrinted').click(function (e) {
          const grid = wijmo.Control.getControl('#theGrid'); // FlexGrid ì¸ìŠ¤í„´ìŠ¤
          const selectedItem = grid?.selectedItems?.[0];

          if (!selectedItem || !selectedItem.BALJUNUM) {
            Alert.alert('', 'ì¶œë ¥í•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
          }

          const baljunum = selectedItem.BALJUNUM;

          const data = {
            baljunum: baljunum
          };

          const url = '/print/purchase'; // ì„œë²„ì—ì„œ ì²˜ë¦¬í•  URL

          AjaxUtil.postAsyncData(url, data, function (response) {
            if (response.success && response.downloadUrl) {
              // ì„œë²„ì—ì„œ ì¶œë ¥íŒŒì¼ URL ë°˜í™˜ ì‹œ ë‹¤ìš´ë¡œë“œ ë˜ëŠ” ìƒˆ ì°½ ì—´ê¸°
              window.open(response.downloadUrl, '_blank');
            } else {
              Alert.alert('', 'ì¶œë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          });
        });//êµ¬ë§¤ í’ˆì˜ì„œ í”„ë¦°íŠ¸

        $('#btnbaljuPrinted').click(function (e) {
          const grid = wijmo.Control.getControl('#theGrid'); // FlexGrid ì¸ìŠ¤í„´ìŠ¤
          let csrfToken = $("[name=_csrf]").val();
          const selectedItem = grid?.selectedItems?.[0];

          if (!selectedItem || !selectedItem.BALJUNUM) {
            Alert.alert('', 'ì¶œë ¥í•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
          }

          const baljunum = selectedItem.BALJUNUM;

          $.ajax({
            url: '/api/balju/balju_order/print/balJuPurchase',
            type: 'POST', // POST ë°©ì‹
            data: {
              BALJUNUM: baljunum
            },
            headers: {
              'X-CSRF-TOKEN': csrfToken
            },
            success: function (response) {
              if (response.success && response.downloadUrl) {
                window.open(response.downloadUrl, '_blank'); // âœ… ì—‘ì…€ ì—´ê¸° or ì €ì¥
              } else {
                Alert.alert('', 'ì¶œë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              }
            },
            error: function () {
              Alert.alert('', 'ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          });

        });//ì™¸ì£¼ë°œì£¼ì„œ í”„ë¦°íŠ¸

      }//init

      showBaljuForm(data) {
        //baljuTemplate
        let _this = this;
        let content = tmpl('baljuTemplate', data);
        let $content = $(content);
        let originalUnitPrice = null;

        let modalContainer = null;
        if (data.mode === 'new') {
          modalContainer = new PopupDraggable('ë°œì£¼ ë“±ë¡');
        } else {
          modalContainer = new PopupDraggable('ë°œì£¼ ìˆ˜ì •');
        }

        //ëª¨ë‹¬ í¬ê¸°
        modalContainer.open({width: 1300, height: 630, $content});
        $('#popSrchDt1').ax5DatePicker({direction: 'top'});
        $('#popSrchDt2').ax5DatePicker({direction: 'top'});

        // ì œí’ˆê²€ìƒ‰
        let $btnProductSearch = $content.find('#btnProductSearch');
        let $btnCompanySearch = $content.find('#btnCompanySearch');
        let $MaterialGroupName = $content.find('#MaterialGroupName');
        let $product_code = $content.find('#product_code');
        let $txtPname = $content.find('#txtPname');
        let $Material_id = $content.find('#Material_id');

        let $baljuForm = $content.find('#baljuForm');

        let $cboBaljuType = $content.find('#cboBaljuType');
        let $cboMaterial = $content.find('#cboMaterial');
        let $baljudate = $content.find('#baljudate');
        let $ichdate = $content.find('#ichdate');

        let $AvailableStock = $('#AvailableStock');
        let $unit = $('#unit');
        let $cboCompany = $('#cboCompany');
        let $CompanyName = $('#CompanyName');
        let $quantity = $('#quantity');
        let $SujuQty = $('#SujuQty');
        let $BaljuUnitPrice = $content.find('#BaljuUnitPrice');
        let $BaljuPrice = $content.find('#BaljuPrice');
        let $BaljuVat = $content.find('#BaljuVat');
        let $isVatExempt = $content.find('#VatExempt').val() === 'Y';
        let $BaljuTotalPrice = $content.find('#BaljuTotalPrice');
        let $vatCheck = $content.find('#VatIncluded');

        let $sujuQty3 = $content.find('#sujuQty3');

        $content.find('#spjangcdHidden').val(data.spjangcd || '');

        if (data.mode === 'new') {
          $btnProductSearch.removeAttr('disabled');

        }

        //ë°œì£¼êµ¬ë¶„(ì •ê¸°ë¥¼ ë””í´íŠ¸ë¡œ)
        AjaxUtil.fillSelectOptions($cboBaljuType, 'system_code', 'choose', 'Regular', 'Balju_type');

        let itemList = [];

        //ê±°ë˜ì²˜
        $content.find('#btnCompanySearch').click(function () {
          let poppage = new PopCompComponentPurchase();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            console.log('btnCompanySearch', items);
            $content.find('#cltcd').val(items.cltcd);
            $content.find('#CompanyName').val(items.cltnm);
            $content.find('#cltemail').val(items.taxmail);
            $content.find('#cltpernm').val(items.agnernm);
            $content.find('#cltjik').val(items.agnerdivinm);
            $content.find('#clttelno').val(items.agntel);

          }
          poppage.show(searchcallback);
        });

        //í˜„ì¥ pm
        $content.find('#btnPernmSearch').click(function () {
          let poppage = new PopStaff();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            $content.find('#pernmcd').val(items.perid);
            $content.find('#pernm').val(items.pernm);
            $content.find('#pernm_rspcdcd').val(items.rspcd);
            $content.find('#pernm_rspcd').val(items.RSPNM);
            $content.find('#pertelno').val(items.handphone);
          };
          poppage.show(searchcallback);
          setTimeout(() => {
            $content.find('#actnm').focus();
          }, 50);
        });

        // âœ… ì´ˆê¸°í™” í•¨ìˆ˜
        function clearPernmInfo($context) {
          $context.find('#pernmcd').val('');
          $context.find('#pernm').val('');
          $context.find('#pernm_rspcdcd').val('');
          $context.find('#pernm_rspcd').val('');
          $context.find('#pertelno').val('');
        }

// âœ… ìë™ì…ë ¥ í•¨ìˆ˜
        function setPernmInfo(item, $context) {
          $context.find('#pernmcd').val(item.perid);
          $context.find('#pernm').val(item.pernm);
          $context.find('#pernm_rspcdcd').val(item.rspcd);
          $context.find('#pernm_rspcd').val(item.RSPNM);
          $context.find('#pertelno').val(item.handphone);

          // ë‹¤ìŒ ì…ë ¥ í¬ì»¤ìŠ¤ë¡œ ì´ë™
          setTimeout(() => {
            $context.find('#actnm').focus();
          }, 50);
        }

// âœ… ì—”í„°í‚¤ ê²€ìƒ‰ ì´ë²¤íŠ¸
        $content.find('#pernm').on('keydown', function (e) {
          if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();

            const keyword = $(this).val().trim();

            // âœ… ì…ë ¥ì´ ì—†ìœ¼ë©´ ë¬´ì¡°ê±´ íŒì—…
            if (keyword === '') {
              const poppage = new PopStaff();
              poppage.show(function (item) {
                if (item && item.perid) {
                  setPernmInfo(item, $content);
                }
              }, ''); // preset ì—†ìŒ
              return;
            }

            // âœ… ì…ë ¥ì´ ìˆìœ¼ë©´ Ajax ê²€ìƒ‰
            AjaxUtil.getAsyncData('/api/popup/search_staff', {
              keyword: keyword,
              spjangcd: sessionStorage.getItem('spjangcd')
            }, function (result) {
              if (!result.success) {
                Alert.alert('', 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return;
              }

              const items = result.data;

              if (items.length === 0) {
                Alert.alert('', 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                clearPernmInfo($content);
              } else if (items.length === 1) {
                setPernmInfo(items[0], $content);
              } else {
                const poppage = new PopStaff();
                poppage.show(function (item) {
                  if (item && item.perid) {
                    setPernmInfo(item, $content);
                  }
                }, keyword); // ê²€ìƒ‰ì–´ preset
              }
            });
          }
        });

        // âœ… ì…ë ¥ì´ ë¹„ë©´ ì´ˆê¸°í™”
        $content.find('#pernm').on('input', function () {
          if ($(this).val().trim() === '') {
            clearPernmInfo($content);
          }
        });

        //í˜„ì¥
        $content.find('#btnactnmSearch').click(function () {
          let poppage = new Popacmtnm();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            console.log('í˜„ì¥ íŒì—…', items);
            $content.find('#actnm').val(items.actnm);
            $content.find('#actcd').val(items.actcd);
            $content.find('#actaddress').val(items.address);
          }
          poppage.show(searchcallback);
          setTimeout(() => {
            $content.find('#CompanyName').focus();
          }, 50);
        });

        $content.find('#btnProjectSearch').click(function () {
          let poppage = new PopProjectList();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            console.log('í”„ë¡œì íŠ¸ëª©ë¡ íŒì—…', items);
            $content.find('#procd').val(items.BOMID);
            $content.find('#eco_no').val(items.eco_no);
            $content.find('#project_no').val(items.project_no);
            $content.find('#PROJECT_NM').val(items.project_nm);

            // bom ë¦¬ìŠ¤íŠ¸ê°€ì§€ê³ ì™€ì„œ ë™ì í–‰ì—
            AjaxUtil.getAsyncData('/api/balju/balju_order/bomList', { eco_no: items.eco_no , project_no: items.project_no }, function (result) {
              if (result.success && result.data.length > 0) {
                const bomList = result.data;
                const $tbody = $content.find('.item-table tbody');
                const $template = $tbody.find('.item-template-row');
                let itemIndex = 0;

                const $rows = $tbody.find('tr:not(.item-template-row)');

                // ê¸°ì¡´ ì…ë ¥ í–‰ ëª¨ë‘ ì´ˆê¸°í™”
                $rows.find('input').val('');

                // í’ˆëª© ë°ì´í„° ìˆœíšŒí•˜ì—¬ í–‰ ì±„ìš°ê¸° or ìƒˆë¡œ ìƒì„±
                bomList.forEach((item, i) => {
                  let $targetRow;

                  if (i < $rows.length) {
                    // ê¸°ì¡´ í–‰ ì¬ì‚¬ìš©
                    $targetRow = $rows.eq(i);
                  } else {
                    // ìƒˆ í–‰ ìƒì„±
                    $targetRow = $template.clone().removeClass('item-template-row').show();

                    // name ê³ ìœ í™”
                    $targetRow.find('input').each(function () {
                      const baseName = $(this).attr('name');
                      if (baseName) {
                        $(this).attr('name', `${baseName}_${itemIndex}`);
                      }
                    });

                    $tbody.append($targetRow);
                    ProductInputHandler.bind({ rowSelector: $targetRow, $content: $content });

                    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
                    ProductInputHandler.bind({
                      rowSelector: $targetRow,
                      $content: $content,
                    });

                    itemIndex++;
                  }

                  fillRowWithItem($targetRow, item);
                });

                // ë‚¨ì€ ê¸°ì¡´ í–‰ì´ ìˆë‹¤ë©´ ë¹„ìš°ê¸° or ì‚­ì œ (ì„ íƒ)
                if ($rows.length > bomList.length) {
                  $rows.slice(bomList.length).remove(); // ë˜ëŠ” .hide()
                }

                function fillRowWithItem($targetRow, item) {
                  $targetRow.find('input[name^="txtPname"]').val(item.PART_NM);
                  $targetRow.find('input[name^="bpid_"]').val(item.bpid);
                  $targetRow.find('input[name^="pcode_"]').val(item.PART_NO);
                  $targetRow.find('input[name^="psize_"]').val(item.PART_SIZE);
                  $targetRow.find('input[name^="punit_"]').val(item.UNIT);
                  $targetRow.find('input[name^="pqty_"]').val(item.QTY);
                  $targetRow.find('input[name^="pmapseq_"]').val(item.DRAWING_NO);
                  $targetRow.find('input[name="isbom_"]').val('Y');

                  $targetRow.addClass('from-bom');
                }
              } else {
                Alert.alert('', 'BOM í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
              }
            });
          }
          poppage.show(searchcallback);
        });

        $content.find('.item-table tbody tr:not(.item-template-row)').each(function () {
          const $row = $(this);
          $row.find('input[name^="totalEdited_"]').val('N');
          const item = {
            id: $row.find('input[name^="balju_id"]').val(),
            productName: $row.find('input[name^="txtPname_"]').val(),
            Material_id: $row.find('input[name^="Material_id_"]').val(),
            quantity: $row.find('input[name^="quantity_"]').val().replace(/,/g, ''),
            unitPrice: $row.find('input[name^="BaljuUnitPrice_"]').val().replace(/,/g, ''),
            supplyPrice: $row.find('input[name^="BaljuPrice_"]').val().replace(/,/g, ''),
            vat: $row.find('input[name^="BaljuVat_"]').val().replace(/,/g, ''),
            total_price: $row.find('input[name^="totalAmount_"]').val().replace(/,/g, ''),
            totalEdited: $row.find('input[name^="totalEdited_"]').val() === 'Y',
            description: $row.find('input[name^="description_"]').val(),
            vatIncluded: $row.find('input[name^="VatIncluded"]').prop('checked') ? 'Y' : 'N',
            cboBaljuType: $row.find('input[name^="BalJuHeadType"]').val()
          };

          console.log("ğŸ” ì €ì¥ë  í•­ëª©:", item);
          itemList.push(item);
        });

        //í¬ì»¤ìŠ¤ ì´ë™
        $content.on('keydown', 'input', function (e) {

        });


        //ë‹¨ê°€ ê²€ìƒ‰
        function tryShowBaljuPrice(row) {
          const $unitPrice = row.find('input[name^="BaljuUnitPrice_"]');
          const $supply = row.find('input[name^="BaljuPrice_"]');
          const $vat = row.find('input[name^="BaljuVat_"]');

          const mat_pk = row.find('input[name^="Material_id_"]').val();
          const company_id = $('#cboCompany').val();
          const baljudate = $('#baljudate').val();

          console.log('[ë‹¨ê°€ ì¡°íšŒ] í˜¸ì¶œë¨', { mat_pk, company_id, baljudate });

          if (!mat_pk || !company_id || !baljudate) {
            console.warn('[ë‹¨ê°€ ì¡°íšŒ] í•„ìˆ˜ê°’ ëˆ„ë½ìœ¼ë¡œ ìš”ì²­ ì·¨ì†Œ');
            return;
          }

          AjaxUtil.getAsyncData('/api/balju/balju_order/price', {
            mat_pk, company_id, baljudate
          }, function (result) {
            console.log('[ë‹¨ê°€ ì¡°íšŒ ê²°ê³¼]', result);

            if (result?.data?.length) {
              const item = result.data[0];
              const unitPrice = item.UnitPrice || 0;
              $unitPrice.val(unitPrice);
              $supply.val(unitPrice);
              $vat.val('');

              row.find('input[name^="originalUnitPrice_"]').val(unitPrice);

            } else {
              $unitPrice.val('');
              $supply.val('');
              $vat.val('');
              row.find('input[name^="originalUnitPrice_"]').val('');
            }
          });
        }
        // ì €ì¥ë²„íŠ¼
        let $btnPopBaljuSave = $('#btnPopBaljuSave');

        // ìƒíƒœ ê°’ ì •ë¦¬
        const isDraft = Array.isArray(data.items) && data.items.every(item =>
          item.chulflag === "0" && item.facflag === "0" && item.hyunflag === "0"
        );

        // ë“±ë¡ ëª¨ë“œì¼ ê²½ìš° â†’ ë²„íŠ¼ ìˆ¨ê¹€
        if (data.mode === 'new') {
          $btnProductSearch.removeAttr('disabled');
        } else {
          // ìƒíƒœê°€ draftê°€ ì•„ë‹ˆë©´ ì €ì¥ ë²„íŠ¼ ìˆ¨ê¸°ê³  ë‹¨ê°€ ì½ê¸° ì „ìš©
          if (!isDraft) {
            $btnPopBaljuSave.hide();
            $BaljuUnitPrice.prop('readonly', true);
          }
        }


        //íŒì—…íƒ€ì´í‹€ ì„¤ì •
        let $popTitle = $content.find('#popTitle');
        if (data.mode === 'new') {
          $popTitle.text('ë°œì£¼ ë“±ë¡');
        } else {
          // ë°œì£¼ ìˆ˜ì •ì‹œ ì œí’ˆê·¸ë£¹ê³¼ ì œí’ˆì„ ìˆ˜ì •í•˜ê²Œ í•  ê²ƒ ì¸ì§€?
          $popTitle.text('ë°œì£¼ ìˆ˜ì •');

          if (data.Company_id) {
            $CompanyName.attr('readonly', true);
          }
        }
        FormUtil.BindDataForm(data, $baljuForm);

        if (data.SujuQty > 0) {
          $SujuQty.val(data.SujuQty.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        }


        // ë°œì£¼ë“±ë¡ íŒì—… ì €ì¥ë²„íŠ¼ í´ë¦­
        $btnPopBaljuSave.click(function (e) {
          let csrfToken = $("[name=_csrf]").val();
          let formData = FormUtil.extractForm($baljuForm); // ìƒë‹¨ ì •ë³´
          formData.spjangcd = $('#spjangcdHidden').val();

          let itemRows = [];
          let priceSaveList = []; // ë³€ê²½ëœ ë‹¨ê°€ë§Œ ì €ì¥
          let isValid = true;

          $content.find('.item-table tbody tr:not(.item-template-row)').each(function () {
            const $row = $(this);

            const item = {
              bpid: $row.find('input[name^="bpid_"]').val(),              // í’ˆëª©ID (hidden)
              pcode: $row.find('input[name^="pcode_"]').val(),            // í’ˆëª©ì½”ë“œ
              pname: $row.find('input[name^="txtPname_"]').val(),         // í’ˆëª…
              psize: $row.find('input[name^="psize_"]').val(),            // ê·œê²©
              punit: $row.find('input[name^="punit_"]').val(),            // ê·œê²©
              quantity: $row.find('input[name^="pqty_"]').val().replace(/,/g, ''), // ìˆ˜ëŸ‰
              unit_price: $row.find('input[name^="puamt_"]').val().replace(/,/g, ''), // ë‹¨ê°€
              amount: $row.find('input[name^="pamt_"]').val().replace(/,/g, ''),     // ê¸ˆì•¡
              pmapseq: $row.find('input[name^="pmapseq_"]').val(),        // ë„ë²ˆ
              remark: $row.find('input[name^="remark_"]').val()           // ë¹„ê³ 
            };

            itemRows.push(item);
            console.log("ğŸ“¦ ì €ì¥í•  itemRows:", itemRows);

          });

          let payload = {
            ...formData,
            items: itemRows
          };
          console.log("ğŸ“¦ ì €ì¥í•  payload:", payload);

          Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
            if (priceSaveList.length > 0) {
              const savePromises = priceSaveList.map(price => {
                return new Promise((resolve, reject) => {
                  $.ajax({
                    type: 'POST',
                    url: '/api/balju/balju_order/savePrice',
                    data: JSON.stringify(price),
                    contentType: 'application/json',
                    headers: {
                      'X-CSRF-TOKEN': csrfToken
                    },
                    success: function (res) {
                      if (res.success) {
                        resolve();
                      } else {
                        reject(res.message || 'ë‹¨ê°€ ì €ì¥ ì‹¤íŒ¨');
                      }
                    },
                    error: function (xhr) {
                      reject(xhr.responseText || 'ì„œë²„ ì˜¤ë¥˜');
                    }
                  });
                });
              });

              Promise.all(savePromises)
                .then(() => {
                  doBaljuSave(payload); // ëª¨ë“  ë‹¨ê°€ ì €ì¥ ì„±ê³µ ì‹œ ë°œì£¼ ì €ì¥
                })
                .catch(err => {
                  Alert.alert('ë‹¨ê°€ ì €ì¥ ì˜¤ë¥˜', err);
                });

            } else {
              doBaljuSave(payload); // ë‹¨ê°€ ë³€ê²½ ì—†ìœ¼ë©´ ë°”ë¡œ ë°œì£¼ ì €ì¥
            }
          });

          // ì‹¤ì œ ë°œì£¼ ì €ì¥ í•¨ìˆ˜
          function doBaljuSave(data) {
            $.ajax({
              type: 'POST',
              url: '/api/balju/balju_order/multi_save',
              data: JSON.stringify(data),
              contentType: 'application/json',
              headers: {
                'X-CSRF-TOKEN': csrfToken
              },
              success: function (res) {
                if (res.success) {
                  Notify.success("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                  _this.searchMainData();
                  modalContainer.close();
                } else {
                  Alert.alert('ì €ì¥ ì‹¤íŒ¨', res.message || 'ì„œë²„ ì˜¤ë¥˜');
                }
              },
              error: function (xhr) {
                console.error('âŒ ë°œì£¼ ì €ì¥ ì‹¤íŒ¨:', xhr.responseText);
                Alert.alert('ì €ì¥ ì˜¤ë¥˜', 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + xhr.responseText);
              }
            });
          }
        });

        // Ctrl + S ë¡œ ì €ì¥ ê°€ëŠ¥í•˜ê²Œ
        $content.on('keydown', function (e) {
          if (e.ctrlKey && e.key.toLowerCase() === 's') {
            e.preventDefault();
            $btnPopBaljuSave.trigger('click');
          }
        });

        FormUtil.BindDataForm(data, $baljuForm);

        let itemIndex = 1;

        // ë°œì£¼ ìˆ˜ì • ì‹œ í’ˆëª© ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        if (data.mode === 'edit' && Array.isArray(data.items)) {
          const $tbody = $content.find('.item-table tbody');
          const $template = $tbody.find('.item-template-row');
          const isDraft = data.items.every(item =>
            item.chulflag === "0" && item.facflag === "0" && item.hyunflag === "0"
          );

          for (let i = 0; i < data.items.length; i++) {
            const item = data.items[i];
            const $newRow = $template.clone().removeClass('item-template-row').show();

            // input name ì†ì„± ê³ ìœ í™”
            $newRow.find('input').each(function () {
              const baseName = $(this).attr('name');
              if (baseName) {
                $(this).attr('name', `${baseName}_${itemIndex}`);
              }
            });

            // ë°ì´í„° ë°”ì¸ë”©
            $newRow.find('input[name^="pcode_"]').val(item.pcode);
            $newRow.find('input[name^="bpid_"]').val(item.bpid);
            $newRow.find('input[name^="punit_"]').val(item.punit);
            $newRow.find('input[name^="BALJUSEQ_"]').val(item.BALJUSEQ);
            $newRow.find('input[name^="txtPname_"]').val(item.txtPname);
            $newRow.find('input[name^="psize_"]').val(item.psize);
            $newRow.find('input[name^="pqty_"]').val(item.pqty);
            $newRow.find('input[name^="puamt_"]').val(item.puamt);
            $newRow.find('input[name^="pamt_"]').val(item.pamt);
            $newRow.find('input[name^="pmapseq_"]').val(item.pmapseq);
            $newRow.find('input[name^="remark_"]').val(item.remark);
            $newRow.find('input[name^="chulflag_"]').val(item.chulflag);
            $newRow.find('input[name^="facflag_"]').val(item.facflag);
            $newRow.find('input[name^="hyunflag_"]').val(item.hyunflag);

            if (!isDraft) {
              $newRow.find('input').prop('readonly', true);
              $newRow.find('a.btn').hide();
            }

            ProductInputHandler.bind({ rowSelector: $newRow, $content: $content });
            $tbody.append($newRow);
            itemIndex++;
          }

          // âœ… ë¶€ì¡±í•œ í–‰ ì¶”ê°€: 3ì¤„ì€ ê¸°ë³¸ ë³´ì¥
          const minRows = 3;
          const existingRows = data.items.length;
          const additionalRows = Math.max(0, minRows - existingRows);

          for (let j = 0; j < additionalRows; j++) {
            const $emptyRow = $template.clone().removeClass('item-template-row').show();

            $emptyRow.find('input').each(function () {
              const baseName = $(this).attr('name');
              if (baseName) {
                $(this).attr('name', `${baseName}_${itemIndex}`);
              }
            });

            ProductInputHandler.bind({ rowSelector: $emptyRow, $content, tryShowBaljuPrice });
            $tbody.append($emptyRow);
            itemIndex++;
          }
        }

        // í–‰ ì¶”ê°€
        $content.find('#addRemark').click(function () {
          const $tbody = $content.find('.item-table tbody');
          const $template = $tbody.find('.item-template-row');

          for (let i = 0; i < 3; i++) {
            const $newRow = $template.clone().removeClass('item-template-row').show();

            $newRow.find('input').each(function () {
              const baseName = $(this).attr('name');
              if (baseName) {
                $(this).attr('name', `${baseName}_${itemIndex}`);
              }
            });

            $tbody.append($newRow);
           ProductInputHandler.bind({ rowSelector: $newRow, $content: $content, tryShowBaljuPrice });

            itemIndex++;
          }
        });

        $content.on('click', 'a[title="í’ˆëª© ê²€ìƒ‰"]', function () {
          const $clickedRow = $(this).closest('tr');
          const $tbody = $content.find('.item-table tbody');
          const $template = $tbody.find('.item-template-row').first();
          const $rows = $tbody.find('tr:not(.item-template-row)');

          const partPopup = new PopPart();
          partPopup.show(function (selectedItems) {
            if (!Array.isArray(selectedItems) || selectedItems.length === 0) return;

            console.log('ì„ íƒëœ í’ˆëª© ëª©ë¡:', selectedItems);

            let itemIndex = $rows.length;

            // í˜„ì¬ ì¡´ì¬í•˜ëŠ” ëª¨ë“  PART_NO ìˆ˜ì§‘
            const existingPartNos = $rows.map(function () {
              return $(this).find('input[name^="pcode"]').val();
            }).get();
            console.log('í˜„ì¬ í…Œì´ë¸”ì— ìˆëŠ” í’ˆëª©ì½”ë“œ ëª©ë¡:', existingPartNos);
            // ë¹ˆ í–‰ í•„í„°ë§
            const $emptyRows = $rows.filter(function () {
              return $(this).find('input[type="text"], input[type="number"]').filter(function () {
                return $(this).val().trim() !== '';
              }).length === 0;
            });
            let usedClickedRow = false;
            for (let i = 0; i < selectedItems.length; i++) {
              const item = selectedItems[i];
              let $targetRow;

              if (!usedClickedRow) {
                // âœ… í´ë¦­í•œ í–‰ì— ë¬´ì¡°ê±´ ë°”ì¸ë”©
                $targetRow = $clickedRow;
                usedClickedRow = true;
              } else if (i < $emptyRows.length) {
              $targetRow = $emptyRows.eq(i);
          } else {
                // ìƒˆ í–‰ ìƒì„±
                const $newRow = $template.clone().removeClass('item-template-row').show();

                $newRow.find('input').each(function () {
                  const baseName = $(this).attr('name');
                  if (baseName) {
                    $(this).attr('name', `${baseName}_${itemIndex}`);
                  }
                });

                $tbody.append($newRow);

                ProductInputHandler.bind({
                  rowSelector: $newRow,
                  $content: $content,
                });

                $targetRow = $newRow;
                itemIndex++;
              }

              fillRowWithItem($targetRow, item);
            }

            // âœ… ì„ íƒëœ í’ˆëª©ì„ í–‰ì— ì±„ìš°ëŠ” í•¨ìˆ˜
            function fillRowWithItem($targetRow, item) {
              $targetRow.find('input[name^="txtPname"]').val(item.PART_NM);
              $targetRow.find('input[name^="bpid"]').val(item.bpid);
              $targetRow.find('input[name^="pcode"]').val(item.PART_NO);
              $targetRow.find('input[name^="psize"]').val(item.PART_SIZE);
              $targetRow.find('input[name^="punit"]').val(item.unit);
              $targetRow.find('input[name^="pmapseq"]').val(item.DRAWING_NO);

              // ì¤‘ë³µ í’ˆëª©ì´ë©´ ë¹„ê³ ë€ì— ë©”ì‹œì§€ í‘œì‹œ
              if (existingPartNos.includes(item.PART_NO)) {
                $targetRow.find('input[name^="remark"]').val('ì´ì¤‘ ë°œì£¼ëœ ì œí’ˆ');
              }
            }
          });
        });


        /* $content.on('click', 'a[title="í’ˆëª© ê²€ìƒ‰"]', function () {
          const $clickedRow = $(this).closest('tr');
          const $tbody = $content.find('.item-table tbody');
          const $template = $content.find('.item-template-row').first(); // ê³ ì • í…œí”Œë¦¿ ì°¸ì¡°
          const $rows = $tbody.find('tr:not(.item-template-row)'); // í˜„ì¬ ì‹¤ì œ ë Œë”ëœ í–‰

          const partPopup = new PopPart();
          partPopup.show(function (selectedItems) {
            if (!Array.isArray(selectedItems) || selectedItems.length === 0) return;

            console.log('ì„ íƒëœ í’ˆëª© ëª©ë¡:', selectedItems);

            for (let i = 0; i < selectedItems.length; i++) {
              const item = selectedItems[i];
              let $targetRow;

              if (i === 0) {
                // ì²« ë²ˆì§¸ ì„ íƒì€ í´ë¦­í•œ ê¸°ì¡´ í–‰
                $targetRow = $clickedRow;
              } else if (i < $rows.length) {
                // ê¸°ì¡´ì˜ ë‚˜ë¨¸ì§€ í–‰ í™œìš©
                $targetRow = $rows.eq(i);
              } else {
                // ë¶€ì¡±í•˜ë©´ ìƒˆ í–‰ ìƒì„±
                const $newRow = $template.clone().removeClass('item-template-row').show();

                // name ì†ì„± ê³ ìœ í™”
                $newRow.find('input').each(function () {
                  const baseName = $(this).attr('name');
                  if (baseName) {
                    $(this).attr('name', `${baseName}_${itemIndex}`);
                  }
                });

                $tbody.append($newRow);

                ProductInputHandler.bind({
                  rowSelector: $newRow,
                  $content: $content,
                  tryShowBaljuPrice,
                });

                $targetRow = $newRow;
                itemIndex++;
              }

              fillRowWithItem($targetRow, item);
            }
          });

          // âœ… ì„ íƒëœ í’ˆëª©ì„ í–‰ì— ì±„ìš°ëŠ” í•¨ìˆ˜
          function fillRowWithItem($targetRow, item) {
            $targetRow.find('input[name^="txtPname"]').val(item.PART_NM);
            $targetRow.find('input[name^="bpid"]').val(item.bpid);
            $targetRow.find('input[name^="pcode"]').val(item.PART_NO);
            $targetRow.find('input[name^="psize"]').val(item.PART_SIZE);
            $targetRow.find('input[name^="punit"]').val(item.unit);
            $targetRow.find('input[name^="pmapseq"]').val(item.DRAWING_NO);
          }
        });*/

        // í¬ì»¤ìŠ¤ ìë™ ì´ë™: Enter + ë°©í–¥í‚¤(â†â†’â†‘â†“)
        $content.on('keydown', 'input', function (e) {
          const key = e.key;

          if (!['Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(key)) return;
          e.preventDefault();

          const $input = $(this);
          const $row = $input.closest('tr');
          const nameAttr = $input.attr('name') || '';

          const focusOrder = [
            'txtPname_',
            'psize_',
            'pqty_',
            'puamt_',
            'pamt_',
            'pmapseq_',
            'remark_',
          ];

          const currentIndex = focusOrder.findIndex(prefix => nameAttr.startsWith(prefix));
          if (currentIndex === -1) return;

          let $nextInput = null;

          // â†”ï¸ ì¢Œìš° ì´ë™
          if (key === 'ArrowRight' && currentIndex < focusOrder.length - 1) {
            const nextPrefix = focusOrder[currentIndex + 1];
            $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
          } else if (key === 'ArrowLeft' && currentIndex > 0) {
            const prevPrefix = focusOrder[currentIndex - 1];
            $nextInput = $row.find(`input[name^="${prevPrefix}"]`);
          }

          // â†•ï¸ ìƒí•˜ ì´ë™
          if (key === 'ArrowDown' || key === 'ArrowUp') {
            const $targetRow = key === 'ArrowDown'
              ? $row.nextAll('tr:visible').first()
              : $row.prevAll('tr:visible').first();

            const allowAutoAdd = ['txtPname_', 'description_'];
            const isAllowedField = allowAutoAdd.some(prefix => nameAttr.startsWith(prefix));

            // â¬‡ï¸ ë°©í–¥í‚¤ + í˜„ì¬ í–‰ì´ ë§ˆì§€ë§‰ + í—ˆìš©ëœ í•„ë“œì¼ ê²½ìš° â†’ í–‰ ìë™ ì¶”ê°€
            if (key === 'ArrowDown' && !$targetRow.length && isAllowedField) {
              $content.find('#addRemark').trigger('click');

              setTimeout(() => {
                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                const $newRow = $rows.last();
                const $newInput = $newRow.find('input[name^="txtPname_"]');
                if ($newInput.length) $newInput.focus().select();
              }, 50);
              return;
            }
            // ì¼ë°˜ ìƒí•˜ ì´ë™
            $nextInput = $targetRow.find(`input[name^="${focusOrder[currentIndex]}"]`);
          }

          // â†µ Enter í‚¤: í˜„ì¬ í–‰ ë‚´ ë‹¤ìŒ í•„ë“œ
          if (key === 'Enter' && currentIndex < focusOrder.length - 1) {
            const nextPrefix = focusOrder[currentIndex + 1];
            $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
          } else if (key === 'Enter' && nameAttr.startsWith('description_')) {
            const $nextRow = $row.nextAll('tr:visible').first();
            if (!$nextRow.length) {
             //console.log('ë‹¤ìŒ í–‰ ì—†ìŒ. í–‰ ìë™ ì¶”ê°€ íŠ¸ë¦¬ê±°.');
              $content.find('#addRemark').trigger('click');

              setTimeout(() => {
                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                const $newRow = $rows.last();
                const $newInput = $newRow.find('input[name^="txtPname_"]');
                if ($newInput.length) $newInput.focus().select();
              }, 50);
              return;
            } else {
              $nextInput = $nextRow.find('input[name^="txtPname_"]');
            }
          }

          if ($nextInput && $nextInput.length) {
            $nextInput.focus().select();
          }
        });

        // ì´ ë¶€ë¶„ì€ ì´ˆê¸° ìŠ¤í¬ë¦½íŠ¸ì— í•œ ë²ˆë§Œ ì„ ì–¸í•˜ë©´ ë¨
        $content.on('click', 'a[title="í–‰ ì‚­ì œ"]', function () {
          const $tbody = $(this).closest('tbody');
          const $rows = $tbody.find('tr:not(.item-template-row)');
          const $targetRow = $(this).closest('tr');

          if ($rows.length <= 3) {
            const hasData = $targetRow.find('input[type="text"], input[type="number"]').filter(function () {
              return $(this).val().trim() !== '';
            }).length > 0;

            if (hasData) {
              $targetRow.find('input[type="text"], input[type="number"]').val('');
              $targetRow.find('input[type="hidden"]').val('');
              $targetRow.find('input[name^="totalAmount_"]').val('0'); // totalAmount ì´ˆê¸°í™”
              $targetRow.removeClass('from-bom');

            }
          } else {
            $targetRow.remove();
          }

          // ğŸ”¥ ëª¨ë“  í–‰ ë‹¤ì‹œ ê³„ì‚°
          $content.find('.item-table tbody tr:not(.item-template-row)').each(function () {
            calculateAmount({ row: $(this), $content });
          });

        });

        if (data.mode === 'new') {
          setTimeout(() => {
            $content.find('#addRemark').trigger('click');
          }, 10);
        }
      }


      deleteBalJuData(id) {
        let _this = this;
        let url = _this.url + '/delete';
        let data = {'id': id  }
        let fnsuccess = function (res) {
          if (res.success) {
            Notify.success('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            _this.searchMainData();
          } else {
            Alert.alert('', res.message);
          }
        };

        AjaxUtil.postAsyncData(url, data, fnsuccess);
      }

      searchMainData() {
        let _this = this;
        let date_kind = $('#cboDateKind').val();  //ë°œì£¼êµ¬ë¶„
        let start = $('#srchStartDt').val();  //ì‹œì‘ì¼
        let end = $('#srchEndDt').val();      //ì¢…ë£Œì¼
        let url = this.url + '/read';

        let data = {
          'date_kind': date_kind,
          'start': start,
          'end': end,
          'action': 'read',
          spjangcd: this.spjangcd.val()
        };

        let fnsuccess = function (result) {
          if (result != null) {
            _this.viewData.sourceCollection = result.data;
          }
        };
        AjaxUtil.getAsyncData(url, data, fnsuccess);
      }
    }
    function isRowEmpty($row) {
      return $row.find('input[type="text"], input[type="number"]').filter(function () {
        return $(this).val().trim() !== '';
      }).length === 0;
    }

    //í–‰ ì‚­ì œ í•¨ìˆ˜
    function removeItemRow(el) {
      const $tbody = $(el).closest('tbody');
      const $rows = $tbody.find('tr:not(.item-template-row)');
      const $targetRow = $(el).closest('tr');

      if ($rows.length <= 3) {
        // ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ì´ˆê¸°í™”ë§Œ í•˜ê³  ë¦¬í„´
        const hasData = $targetRow.find('input[type="text"], input[type="number"]').filter(function () {
          return $(this).val().trim() !== '';
        }).length > 0;

        if (hasData) {
          $targetRow.find('input[type="text"], input[type="number"]').val('');
          // hidden ê°’ë„ ì´ˆê¸°í™”í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì¶”ê°€
          $targetRow.find('input[type="hidden"]').val('');
        }

        return;
      }

      // 4ê°œ ì´ìƒì´ë©´ ì •ìƒ ì‚­ì œ
      $targetRow.remove();
    }


    function formatNumberInput(inputValue, targetSelector) {
      let cleaned = inputValue.replace(/[^0-9]/g, '').replace(/,/g, '');// ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
      let formatted = cleaned.replace(/\B(?=(\d{3})+(?!\d))/g, ',');// ì‰¼í‘œ ë„£ê¸°
      $(targetSelector).val(formatted);// ê°’ ë„£ê¸°
    }

    function calculateAmount({ row: $row }) {
      const $qtyField = $row.find('input[name^="pqty_"]');
      const $unitPriceField = $row.find('input[name^="puamt_"]');
      const $totalField = $row.find('input[name^="pamt_"]');

      const qty = parseFloat($qtyField.val().replace(/,/g, '') || '0');
      const unitPrice = parseFloat($unitPriceField.val().replace(/,/g, '') || '0');
      const totalPrice = qty * unitPrice;

      // âœ… ë‹¨ê°€ í•„ë“œ ë‹¤ì‹œ í¬ë§· (ì‰¼í‘œ ë„£ê¸°)
      formatNumberInput(unitPrice.toString(), $unitPriceField);

      // âœ… ìˆ˜ëŸ‰ í•„ë“œë„ í¬ë§·
      formatNumberInput(qty.toString(), $qtyField);

      // âœ… ìë™ ê³„ì‚°ëœ ê¸ˆì•¡ë§Œ í¬ë§·í•´ì„œ ë°˜ì˜
      if ($row.data('totalEdited') !== true) {
        formatNumberInput(totalPrice.toString(), $totalField);
      }
    }

    let page = null;
    var picker = new ax5.ui.picker();

    $(document).ready(function (e) {

      const spjangcd = sessionStorage.getItem('spjangcd');
      if (spjangcd) {
        $('#spjangcdHidden').val(spjangcd);  // hidden inputì´ ìˆì–´ì•¼ í•¨
      }

      page = new BaljuOrderPage();

      $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
      $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

      page.searchMainData();

      // ê²€ìƒ‰
      $('#btnSearch').click(function (e) {
        page.searchMainData();
      });

    });
  </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>