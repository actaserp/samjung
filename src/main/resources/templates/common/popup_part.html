<th:block th:fragment="popup_part">
  <script type="text/x-tmpl" id="popup_partSearchTemplate">

    <div class="content_wrap popup">

        <section class="section" style="padding-top: 10px;">

            <div class="section-top">
                <div class="search-wrap" style="text-align: left;">
                    <dl>
                        <dt>
                            <label for="PART_NM">
                                품목명<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input type="text" id='PART_NM' name="PART_NM" style="width:160px;"/>
                            </div>
                        </dd>
                    </dl>

                    <dl>
                        <dt>
                            <label for="PART_NO">
                                품목코드 <span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input class="form-control2" type="text" id="PART_NO" name="PART_NO" style="width:160px;"/>
                            </div>
                        </dd>
                    </dl>

                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="검색" id="btnpartSearch">
                                    <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                    <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                    검색
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
                <div class="container-fluid">
                    <div id="theGrid2" style="height: 270px;"></div>
                </div>
            </div>

        </section>
            <div class="popup-button">
                <button type="button" class="btn-popup" id="btnCompSelect" style="height: 40px;"><span data-commonCd="선택">선택</span></button>
                <button type="button" class="btn-popup" id="btn-search-close" style="height: 40px;"><span data-commonCd="닫기">닫기</span></button>
            </div>
    </div>
  </script>

  <script type="text/javascript">

    class PopPart {
      static currentInstance = null;

      constructor() {
        if (PopPart.currentInstance) {
          PopPart.currentInstance.close(); // 이전 인스턴스 닫기
        }
        PopPart.currentInstance = this;

        this.grid = null;
        this.viewData = new wijmo.collections.CollectionView();
        this.selectedItem = null;
        this.callback = null;
        this.modalContainer = new PopupDraggable('직원 선택');
        this.$btnpartSearch = null;
        this.$btnCompSelect = null;
        this.$PART_NM = null;
        this.previousFocus = null;
      }

      searchDataBind() {
        let _this = this;
        let url = '/api/popup/search_part';
        let data = {
          'part_no': _this.$part.val(),
          'PART_NM' : _this.$PART_NM.val()
        };

        let result = AjaxUtil.getSyncData(url, data);
        if (result) {
          _this.viewData.sourceCollection = result.data;
          // 첫 번째 행으로 포커스 이동
          setTimeout(() => {
            if (_this.grid && _this.grid.rows.length > 0) {
              _this.grid.select(0, 0); // 첫 번째 행, 첫 번째 열 선택
              _this.grid.focus(); // 그리드에 포커스
            }
          }, 0);
          setTimeout(() => {
            if (_this.grid.rows.length > 0) {
              let colIndex = _this.grid.columns.findIndex(col => col.binding === 'accountNumber');

              if (colIndex > -1) {
                _this.grid.select(0, colIndex);
                _this.grid.selection = new wijmo.grid.CellRange(0, colIndex);
                _this.grid.focus();
              }
            }
          }, 100);
        }

        //검색버튼을 누르고 초기화한다
        this.selectedItem = null;
      }

      selectData(item) {
        this._skipAutoFocus = false;

        if (typeof this.callback === 'function') {
          this._skipAutoFocus = true; // 콜백 안에서 포커스 줄 예정
          this.callback(item);
        }

        this.close();
      }

      show(callback, presetKeyword = '') {
        let _this = this;

        this.callback = callback;

        let content = tmpl('popup_partSearchTemplate', {});
        let $content = $(content);
        this.modalContainer.open({width: 800, height: 500, $content});

        setTimeout(() => {

          const el = document.getElementById('theGrid2');
          if (!el) {
            return;
          }

          const existingGrid = wijmo.Control.getControl(el);
          if (existingGrid) {
            existingGrid.dispose();
          }

          this.grid = new wijmo.grid.FlexGrid('#theGrid2', {
            selectionMode: wijmo.grid.SelectionMode.Row,
            autoGenerateColumns: false,
            showMarquee: true,
            isReadOnly: true,
            keyActionEnter: wijmo.grid.KeyAction.None,
            columns: [
              {binding: 'PART_NO', header: '품목번호', width: 120, align: 'left'},
              {binding: 'PART_NM', header: '품목명', width: '*', align: 'center'},
              {binding: 'unit', header: '단위', width: 50 , align: 'left'},
              {binding: 'PART_SIZE', header: 'size', width: 100, align: 'left'},
              {binding: 'spec', header: 'spec', width: 100, align: 'left'},
            ],
            itemsSource: this.viewData,
          });
          this.grid.rowHeaders.columns.splice(0, 1);
          new FlexGridContextMenu(this.grid);
          this.grid.downloadFileName = '품목 선택';

          this.$btnpartSearch = $content.find('#btnpartSearch');
          this.$part = $content.find('#part');
          this.$PART_NM = $content.find('#PART_NM');
          this.$btnCompSelect = $content.find('#btnCompSelect');


          this.$btnpartSearch.click(function (e) {
            _this.searchDataBind();
          });

          $('#btnpartSearch').click();


          this.$btnCompSelect.click(function (e) {
            // 그리드에서 현재 선택된 item을 찾아서 호출한다.
            let items = _this.grid.selectedItems;
            if (items.length === 0) {
              return false;
            }
            _this.selectData(items[0]);
          });


          //닫기버튼을 아래 ID로 사용한다면 호출하는 화면에서 이벤트 처리 필요없음
          $content.find('#btn-search-close').on('click', function () {
            _this.close();
          });

          //새로고침
          // $('#btnTest').click(function (e) {
          //     _this.grid.collectionView.refresh(); // Wijmo 그리드 새로고침
          // });

          this.grid.hostElement.addEventListener('dblclick', function (e) {
            let items = _this.grid.selectedItems;
            if (items.length === 0) {
              return false;
            }
            _this.selectData(items[0]); // btnCompSelect 클릭과 동일한 동작
          });

          if (presetKeyword && this.$part.length > 0) {
            this.$part.val(presetKeyword);
            this.$btnStaffSearch.trigger('click');
          }

          this.grid.hostElement.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
              setTimeout(() => {
                const selected = _this.grid.selectedItems;
                if (selected.length > 0) {
                  _this.selectData(selected[0]);
                } else {
                  console.log('선택된 행 없음');
                }
              }, 0); // 다음 이벤트 루프에서 실행
            }
          });

          this._escHandler = function (e) {
            if (e.key === 'Escape' || e.keyCode === 27) {
              _this.close();
            }
          };
          $(document).on('keydown.popupesc', this._escHandler);

          // 모달 닫힐 때 포커스 복원
          this.modalContainer.onClose = () => {
            // ESC 후 포커스 복원
            if (this.focusAfterClose && document.body.contains(this.focusAfterClose)) {
              setTimeout(() => {
                this.focusAfterClose.focus();
              }, 50);
            }
            // ESC 이벤트 제거
            $(document).off('keydown.popupesc', this._escHandler);
          };
        }, 50);
      }

      close() {
        this.modalContainer.close();

        // 팝업 컨텐츠 DOM 수동 제거
        if (this.modalContainer.$content) {
          this.modalContainer.$content.remove();
          this.modalContainer.$content = null;
        }

        // 포커스 복원
        if (!this._skipAutoFocus && this.focusAfterClose && document.body.contains(this.focusAfterClose)) {
          setTimeout(() => {
            this.focusAfterClose.focus();
          }, 50);
        }

        // ESC 이벤트 제거
        $(document).off('keydown.popupesc', this._escHandler);

        // 싱글턴 정리
        if (PopPart.currentInstance === this) {
          PopPart.currentInstance = null;
        }
      }

    }

    $(document).on('keydown', '#PART_NM', function (e) {
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault();
        $('#btnpartSearch').trigger('click');
      }
    });

    $(document).on('keydown', '#PART_NO', function (e) {
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault();
        $('#btnpartSearch').trigger('click');
      }
    });

  </script>