<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>
    .container-fluid {
        padding: 20px;
    }
    .modal-content {
        position: absolute; /* absoluteë¡œ ì„¤ì •í•˜ì—¬ í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜ */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); /* í™”ë©´ ì¤‘ì•™ ì •ë ¬ */
        background-color: #fff;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 700px;
        border-radius: 8px;
    }

    .chart-container {
        position: relative; /* ë¶€ëª¨ ìš”ì†Œì— ìœ„ì¹˜ ê³ ì • */
        width: 100%; /* ì›í•˜ëŠ” ë„ˆë¹„ */
        height: 250px; /* ê³ ì •ëœ ë†’ì´ */
        overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™” */
        overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë¹„í™œì„±í™” */
        border: 1px solid #ccc; /* í…Œë‘ë¦¬ ì¶”ê°€ (ì„ íƒ ì‚¬í•­) */
        padding: 10px; /* ì—¬ë°± ì¶”ê°€ (ì„ íƒ ì‚¬í•­) */
    }

    #modalGrid {
        height: auto;        /* ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì • */
        max-height: 500px;   /* í•„ìš”ì— ë”°ë¼ ìµœëŒ€ ë†’ì´ë¥¼ ì§€ì • */
        overflow-y: auto;    /* ìŠ¤í¬ë¡¤ í™œì„±í™” */
    }
</style>
<th:block layout:fragment="content">
  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>ì—…ì²´ë³„ ì£¼ë¬¸í†µê³„</h2><a id="toggleButton" onclick="toggleSearchWrap()"><img src="/images/icon/ico-down.png"
                                                                             alt="ì•ŒëŒ ì•„ì´ì½˜"></a>
        <!--<a title="ë¶ë§ˆí¬" class="bookmark toggle">
            ë‚´ë©”ë‰´
        </a>-->
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ì£¼ë¬¸ê´€ë¦¬</li>
        <li>ì—…ì²´ë³„ ì£¼ë¬¸í†µê³„</li>
      </ul>
    </div>
    <div class="search-wrap" id="searchWrap" style="display: none; padding-top:10px">
      <ul>
        <li>
          <select title="ì‚¬ì—…ì¥" id="search_spjangcd" name="search_spjangcd"
                  onchange="init()">
            <option value="" hidden selected disabled>ì„ íƒ</option>
            <option value="ZZ">ì„±ìš°ì—ìŠ¤í”¼(ì£¼)</option>
            <option value="PP">ì„±ìš°í”¼ì•¤ë¹„(ì£¼)</option>
            <!-- ì§€ì—­ ì˜µì…˜ì„ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì±„ì›€ -->
          </select>
        </li>
      </ul>
    </div>
    <!-- Select -->
    <div class="tab-contents">
      <section class="tab-item" style="height: 840px; overflow: hidden;">
        <div class="section-top">
          <div class="search-wrap">
            <dl>
              <dt>
                ì¡°íšŒê¸°ê°„<span class="eq">*</span>
                <img src="/images/icon/exclamation/exclamation-circle.svg"
                     class="zoom-img" style="margin-left: 5px"
                     onclick="openPopup('https://foms.atlassian.net/wiki/external/Yjk4ODJlMzgxYWI5NDcwMjhlYWRhYzkwMzgxNTcyNjc')" alt="ë„ì›€ë§">
              </dt>
              <dd>
                <ul class="date-box">
                  <li>
                    <input type="date" id="startDate" name="startDate">
                    <label for="startDate" class="hide">ì‹œì‘ì¼</label>
                  </li>
                  <li>
                    <input type="date" id="endDate" name="endDate">
                    <label for="endDate" class="hide">ì¢…ë£Œì¼</label>
                  </li>
                </ul>
              </dd>
            </dl>
            <dl>
              <dt>
                <label for="searchCltnm">
                  ì—…ì²´ëª…
                </label>
              </dt>
              <dd>
                <div class="srch-box">
                  <input type="text" id="searchCltnm" name="searchCltnm" class="input-srch"
                         placeholder="ì—…ì²´ëª…" style="border-radius: 5px;">
                </div>
              </dd>
            </dl>
            <dl>
              <dt>&nbsp;</dt>
              <dd>
                <li>
                  <a class="btn btn-delete" title="ê²€ìƒ‰" id="searchButton" onclick="searchButton()">
                    <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                    ê²€ìƒ‰
                  </a>
                </li>
              </dd>
            </dl>
          </div>
        </div>
        <div class="container-fluid" style="display: flex;">
          <div class="chart-container wp50">
            <canvas id="myChart" width="500" height="500"></canvas>
            <span id="noDataMessage" style="margin-top: 150px; display: none; text-align: center; color: gray;">ì¡°íšŒ ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
          </div>
          <span class="material-symbols-outlined"  onclick="openModal()">zoom_out_map</span>
          <div class="wp50">
            <div >
              <p id="selectedItem"></p>
              <div id="theGrid" style="max-height:730px"></div>
            </div>
          </div>
        </div>
      </section>
    </div> <!--//tab-wrap end-->
  </div> <!--//layout-contents end -->

  <!--ì—…ì²´ ëª¨ë‹¬-->
  <div class="modal">
    <div id="CltnmModal" style="display: none;">
      <div class="modal-content">
        <h2 style="text-align: center;">ê±°ë˜ì²˜ ì •ë³´ ìƒì„¸</h2>
        <a title="íŒì—…ë‹«ê¸°" onclick="closePopup('CltnmModal')" class="btn-popup-close">
          <img src="/images/icon/btn-popup-close.svg" style=" float: right; right: 30px;" alt="ë‹«ê¸°">
        </a>
        <form id="CltnmFindForm">
          <div id="modalGrid" style="height: 350px;width: 100%; margin-right:0px;  margin-top: 20px;"></div>
        </form>
      </div>
    </div>
  </div>

  <footer>
    <p>Copyrightâ“’ 0000 corp. All rights reserved.</p>
  </footer>

</th:block>

<div id="chartModal" class="modal" style="opacity:100">
  <div class="modal-content">
    <span class="close">&times;</span>
    <canvas id="modalChartHolder" style="width: 1250px; height: 490px; display: block; box-sizing: border-box;"
            width="1250" height="520"></canvas>
  </div>
</div>



<th:block layout:fragment="scripts">
  <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/javascript">
    var theGrid;
    let modalGrid;

    document.readyState === 'complete' ? init() : window.onload = init;
    let isBindSpjangcdCalled = false;

    <!-- ì´ˆë°˜ í˜ì´ì§€ ì§„ì…ì‹œ ê·¸ë¦¬ë“œ ë°”ì¸ë”© ë-->
    function init() {
      fetchListData();
      loadChartData();
      if (!isBindSpjangcdCalled) {
        bindSpjangcd();
        isBindSpjangcdCalled = true; // í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
      }
      document.getElementById('search_spjangcd').addEventListener('change', searchButton);
    }

    $(document).ready(function () {
      // í˜„ì¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth(); // 0ë¶€í„° ì‹œì‘í•˜ëŠ” ì›”(0 = 1ì›”)

      // ì‹œì‘ì¼: ì´ë²ˆ ë‹¬ 1ì¼
      const startOfMonth = new Date(year, month, 1);
      const startMonthFormatted = startOfMonth.getFullYear() + '-' + String(startOfMonth.getMonth() + 1).padStart(2, '0') + '-' + String(startOfMonth.getDate()).padStart(2, '0');
      $('#startDate').val(startMonthFormatted);

      // ì¢…ë£Œì¼: ì˜¤ëŠ˜ ë‚ ì§œ
      const todayFormatted = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
      $('#endDate').val(todayFormatted);
    });

    function fetchListData() {
      let data = [ ];
      const params = {
        search_spjangcd: $('#search_spjangcd').val(),
        startDate: $('#startDate').val(),
        endDate: $('#endDate').val(),
        searchUserNm: $('#searchUserNm').val(),
        searchCltnm: $('#searchCltnm').val(),
      };

      // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      $.ajax({
        url: '/api/VendorOrderStats/read',
        type: 'GET',
        data: params,
        async: false,
        success: function (response) {
          // ì‘ë‹µì´ ì˜¬ë°”ë¥´ê²Œ ë„ì°©í–ˆê³ , data ì†ì„±ì´ ë°°ì—´ì¸ì§€ í™•ì¸
          if (response && Array.isArray(response.data)) {
            data = response.data.map((item, index) => ({
              rownum: index + 1,
              reqdate: item.reqdate ||'',
              ordflag_display: item.ordflag_display ||'',
              cltnm: item.cltnm ||'',
              telno: item.telno ||'',
              perid: item.perid || '',
              orderprice: item.orderprice || '',
              deldate: item.deldate || '',
              remark: item.remark ||'',
            }));
          }
        },
        error: function () {
          console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });

      while (data.length < 15) {
        data.push({
          rownum: data.length + 1,
          reqdate: '',
          ordflag_display:'',
          cltnm: '',
          perid :'',
          telno: '',
          orderprice: '',
          deldate: '',
          remark: ''
        });
      }

      viewdata = new wijmo.collections.CollectionView(data);
      // ê¸°ì¡´ ê·¸ë£¹ ì œê±° í›„ `cltnm`(ì—…ì²´ëª…) ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™” ì ìš©
      viewdata.groupDescriptions.clear();
      let groupDesc = new wijmo.collections.PropertyGroupDescription('cltnm');
      viewdata.groupDescriptions.push(groupDesc);

      // ê·¸ë£¹ë³„ í–‰ ë²ˆí˜¸ ë‹¤ì‹œ ì„¤ì • í•¨ìˆ˜
      const resetRowNumbers = () => {
        viewdata.groups.forEach((group) => {
          let rowNumber = 1; // ê° ê·¸ë£¹ë³„ í–‰ ë²ˆí˜¸ ì´ˆê¸°í™”
          group.items.forEach(item => {
            item.rownum = rowNumber++;
          });
        });
      };

      // ê·¸ë£¹í™”ëœ ë°ì´í„°ì˜ ìˆœë²ˆì„ ë‹¤ì‹œ ê³„ì‚°
      resetRowNumbers();

      if (!theGrid) {
        theGrid = new wijmo.grid.FlexGrid('#theGrid', {
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          columns: [
            {binding: 'rownum', header: 'ìˆœë²ˆ', width: 80, align: 'center'},
            {binding: 'reqdate', header: 'ì£¼ë¬¸ì¼ì', width: '*', minWidth: 160, align: 'center'},
            {binding: 'cltnm', header: 'ì—…ì²´ëª…', width: '*', minWidth: 250, align: 'left'},
            {binding: 'ordflag_display', header: 'ì§„í–‰êµ¬ë¶„', width: '*', minWidth: 100, align: 'center'},
            {binding: 'remark', header: 'ì œëª©(ë©”ëª¨)', width: '*', minWidth: 550, align: 'left'},
            {binding: 'perid', header: 'ë‹´ë‹¹ì', width: '*', minWidth: 120, align: 'center'},
            {binding: 'telno', header: 'ì—°ë½ì²˜', width: '*', minWidth: 180, align: 'center'},
            {binding: 'orderprice', header: 'ê¸ˆì•¡', width: '*', minWidth: 180, align: 'center'},
            {binding: 'deldate', header: 'ì¶œê³ ì¼ì', width: '*', minWidth: 160, align: 'center'},
          ],
          itemsSource: viewdata,
        });

        theGrid.rowHeaders.columns.splice(0, 1);
        // ContextMenu ì¶”ê°€
        new FlexGridContextMenu(theGrid);
        window.downloadFileName = 'íšŒì›ê´€ë¦¬';
      } else {
        theGrid.itemsSource = viewdata;
      }
    }

    function loadChartData() {
      const spjangcd = document.getElementById('search_spjangcd').value;
      const startDate = document.getElementById('startDate').value || "";
      const endDate = document.getElementById('endDate').value || "";
      const searchCltnm = document.getElementById('searchCltnm').value.trim() || "";

      const queryParams = {
        search_spjangcd: spjangcd,
        startDate: startDate,
        endDate: endDate,
        searchCltnm: searchCltnm,
      };
      const urlParams = new URLSearchParams(queryParams).toString();

      $.ajax({
        url: `/api/VendorOrderStats/getChartData?${urlParams}`,
        method: 'GET',
        dataType: 'json',
        success: function (response) {
          if (response.success && response.data && response.data.length > 0) {
            // ğŸ“Œ ë°ì´í„° ê°€ê³µ: ì£¼ë¬¸ ìƒíƒœë³„ ê°œìˆ˜ ê³„ì‚°
            const orderCounts = {
              "ì£¼ë¬¸ì·¨ì†Œ": 0,
              "ì£¼ë¬¸ë“±ë¡": 0,
              "ì£¼ë¬¸í™•ì¸": 0,
              "ì£¼ë¬¸í™•ì •": 0,
              "ì œì‘ì§„í–‰": 0,
              "ì¶œê³ ": 0
            };

            response.data.forEach(item => {
              const status = stageMapping[item.ordflag] || "ê¸°íƒ€";
              if (orderCounts[status] !== undefined) {
                orderCounts[status]++;
              }
            });

            // ğŸ“Œ ì´ ê±´ìˆ˜ ê³„ì‚°
            const totalOrders = response.data.length;

            // ğŸ“Œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            initializeChart(orderCounts, totalOrders);
          } else {
            console.log(response.message || "ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            initializeChart({}, 0); // ë°ì´í„° ì—†ì„ ê²½ìš° ì´ˆê¸°í™”
          }
        },
        error: function () {
          console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
          initializeChart({}, 0);
        }
      });
    }

    // ìˆ«ì â†’ ê°’ ë§¤í•‘ ê°ì²´
    const stageMapping = {
      5: "ì£¼ë¬¸ì·¨ì†Œ",
      0: "ì£¼ë¬¸ë“±ë¡",
      1: "ì£¼ë¬¸í™•ì¸",
      2: "ì£¼ë¬¸í™•ì •",
      3: "ì œì‘ì§„í–‰",
      4: "ì¶œê³ ",

    };
    //ì°¨íŠ¸
    console.log(Chart.version); // ì½˜ì†”ì—ì„œ Chart.js ë²„ì „ì„ í™•ì¸


    $(document).ready(function () {
      initializeChart(function () {
        loadChartData(); // ì°¨íŠ¸ ì´ˆê¸°í™” í›„ ë°ì´í„° ë¡œë“œ
      });
    });

    window.openModal = function () {
      let chartElement = document.getElementById('myChart');

      // Chart.js ë°©ì‹ìœ¼ë¡œ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
      let chartInstance = Chart.getChart(chartElement);

      if (!chartInstance) {
        console.error("ì°¨íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        Alert.alert('',"ì¡°íšŒ ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      let modal = $('#chartModal');
      modal.show();

      let modalChartHolder = $('#modalChartHolder')[0].getContext('2d');

      // ê¸°ì¡´ ëª¨ë‹¬ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ
      if (window.modalChartInstance) {
        window.modalChartInstance.destroy();
      }

      // ëª¨ë‹¬ ì°¨íŠ¸ ìƒì„± (ê¸°ì¡´ ì°¨íŠ¸ ë°ì´í„° ìœ ì§€)
      window.modalChartInstance = new Chart(modalChartHolder, {
        type: chartInstance.config.type,
        data: chartInstance.config.data,
        options: chartInstance.config.options
      });
    };

    $(document).on('click', '.close', function () {
      $('#chartModal').hide();
      if (window.modalChartInstance) {
        window.modalChartInstance.destroy();
      }
    });

    $(window).on('click', function (event) {
      if ($(event.target).is('#chartModal')) {
        $('#chartModal').hide();
        if (window.modalChartInstance) {
          window.modalChartInstance.destroy();
        }
      }
    });

    function initializeChart(orderCounts = {}, totalOrders = 0) {
      const chartElement = document.getElementById('myChart');
      const noDataMessage = document.getElementById('noDataMessage'); // ë©”ì‹œì§€ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°

      if (!chartElement) {
        console.error('Chart element not found!');
        return;
      }

      const ctx = chartElement.getContext('2d');

      // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
      const existingChart = Chart.getChart(chartElement);
      if (existingChart) {
        existingChart.destroy();
      }

      const labels = ["ì£¼ë¬¸ì·¨ì†Œ", "ì£¼ë¬¸ë“±ë¡", "ì£¼ë¬¸í™•ì¸", "ì£¼ë¬¸í™•ì •", "ì œì‘ì§„í–‰", "ì¶œê³ "];
      const coloredData = labels.map(label => orderCounts[label] || 0);

      // ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
      const hasData = coloredData.some(count => count > 0);

      if (!hasData) {
        // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš°
        chartElement.style.display = 'none'; // ì°¨íŠ¸ ìˆ¨ê¸°ê¸°
        noDataMessage.style.display = 'block'; // ë©”ì‹œì§€ í‘œì‹œ
        return;
      }

      // ë°ì´í„°ê°€ ìˆì„ ê²½ìš°
      chartElement.style.display = 'block'; // ì°¨íŠ¸ ë³´ì´ê¸°
      noDataMessage.style.display = 'none'; // ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°

      const data = {
        labels: labels,
        datasets: [
          {
            label: 'ê° ê±´ìˆ˜',
            data: coloredData,
            backgroundColor: [
              'rgba(255, 99, 132, 0.3)',
              'rgba(255, 159, 64, 0.4)',
              'rgba(255, 215, 0, 0.4)',
              'rgba(75, 192, 192, 0.5)',
              'rgba(54, 162, 235, 0.4)',
              'rgba(153, 102, 255, 0.2)'
            ]
          }
        ]
      };

      const config = {
        type: 'pie',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
          }
        }
      };

      // config ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì°¨íŠ¸ ìƒì„±
      new Chart(ctx, config);
    }

    //ê²€ìƒ‰
    function searchButton() {
      // ì…ë ¥ëœ ê°’ ê°€ì ¸ì˜¤ê¸°
      const search_spjangcd = document.getElementById('search_spjangcd').value || "";
      const startDate = document.getElementById('startDate').value || "";
      const endDate = document.getElementById('endDate').value || "";
      const searchCltnm = document.getElementById('searchCltnm').value.trim() || "";

      // ê²€ìƒ‰ ìš”ì²­ ë°ì´í„° êµ¬ì„±
      const queryParams = {
        search_spjangcd,
        startDate,
        endDate,
        searchCltnm,
      };

      // ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ
      loadChartData(queryParams);
      fetchListData(queryParams);
    }

    // ì‚¬ì—…ì¥
    function bindSpjangcd() {
      $.ajax({
        url: '/api/dashboard2/bindSpjangcd',
        type: 'GET',
        async: false,
        success: function (data) {
          data2 = data.data;
          const selectElement = document.getElementById('search_spjangcd');
          if (selectElement) {
            selectElement.value = data2; // value ì†ì„±ìœ¼ë¡œ ì„ íƒ
          }
        }
      })
    }

    function openPopup(url) {
      // ìƒˆ ì°½ ì—´ê¸°
      window.open(url, '_blank',
        'width=1040,height=1000,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes');
    }

    //ê³µí†µì½”ë“œ
    const selectConfigs = [
      {parentCode: 'ordflag', elementId: 'searchtketnm'},
    ];
    selectConfigs.forEach(config => {
      initializeSelect3({
        url: '/api/order_status/ordFlagType',
        params: {parentCode: config.parentCode},
        elementId: config.elementId,
        valueField: "code",
        textField: "value",
        includeAllOption: true, // "ì „ì²´" ì˜µì…˜ ì‚¬ìš©
      });
    });

    //ì—…ì²´ëª… ëª¨ë‹¬
    document.getElementById('searchCltnm').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        console.log('Enter key pressed, showing CltnmModal...');
        showPopupById('CltnmModal');  // ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ í˜¸ì¶œ
        modalGrid();  // ëª¨ë‹¬ ê·¸ë¦¬ë“œ ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ
      }
    });
    const modalDataLoaders = {
      'CltnmModal': modalDeta,
    };

    function showPopupById(popupId, rowIndex = null) {
      const popup = document.getElementById(popupId);
      if (popup) {
        const modal = popup.closest('.modal');
        if (modal) {
          modal.style.display = 'block';
          requestAnimationFrame(() => modal.classList.add('show'));
        }
        popup.style.display = 'block';
        requestAnimationFrame(() => popup.classList.add('show'));

        // ëª¨ë‹¬ì´ ì—´ë¦¬ë©´ì„œ í•´ë‹¹ ëª¨ë‹¬ì˜ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ
        const loadDataFunction = modalDataLoaders[popupId];
        if (typeof loadDataFunction === 'function') {
          try {
            // rowIndexê°€ í•„ìš”í•  ê²½ìš°ì—ë§Œ ì „ë‹¬
            if (popupId === 'OrdtextModal' && rowIndex !== null) {
              loadDataFunction(rowIndex);
            } else {
              loadDataFunction();
            }
          } catch (error) {
            console.error(`Error loading data for modal '${popupId}':`, error);
          }
        } else {
          console.log(`No data load function defined for modal with ID: ${popupId}`);
        }

        console.log(`Showing modal with ID: ${popupId}`);
      } else {
        console.warn(`Popup with ID '${popupId}' not found.`);
      }
    }
    // ëª¨ë‹¬ì„ ë‹«ëŠ” í•¨ìˆ˜
    function closePopup(popupId) {
      const popup = document.getElementById(popupId);
      if (popup) {
        const modal = popup.closest('.modal');
        if (modal) {
          modal.style.display = 'none';
          modal.classList.remove('show');
        }
        popup.style.display = 'none';
        popup.classList.remove('show');
        console.log(`Closing modal with ID: ${popupId}`);
      }
    }

    function modalDeta() {
      console.log('Initializing modal grid...');
      const Modaldata = [];
      const minimumRows = 13;

      // searchTermì„ ì…ë ¥ í•„ë“œì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤ (ì˜ˆ: #searchCltnm)
      const searchTerm = $('#searchCltnm').val();

      $.ajax({
        url: '/api/order_status/ModalRead',
        type: 'GET',
        data: { searchTerm: searchTerm }, // searchTermì„ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€
        async: true,
        success: function(response) {
          if (response && Array.isArray(response.data)) {
            response.data.forEach((item, index) => {
              Modaldata.push({
                rownum: index + 1,  // ìˆœë²ˆì„ ì¶”ê°€
                ...item
              });
            });
          }

          // ìµœì†Œ í–‰ ìˆ˜ ì±„ìš°ê¸°
          if (Modaldata.length < minimumRows) {
            for (let i = Modaldata.length; i < minimumRows; i++) {
              Modaldata.push({
                rownum: i + 1,
                cltcd: '',
                cltnm: '',
                telnum: '',
                cltadres: ''
              });
            }
          }

          // ë””ë²„ê¹…: ë°ì´í„° í™•ì¸
          console.log("Data length after adding empty rows:", Modaldata.length);

          // ë°ì´í„°ë¥¼ CollectionViewì— ë°”ì¸ë”©
          const viewdata = new wijmo.collections.CollectionView(Modaldata);

          // ê¸°ì¡´ ê·¸ë¦¬ë“œ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
          if (modalGrid) {
            modalGrid.dispose();
          }

          modalGrid = new wijmo.grid.FlexGrid('#modalGrid', {
            autoGenerateColumns: false,
            isReadOnly: true,
            columns: [
              {binding: 'rownum', header: 'ìˆœë²ˆ', width: 50, align: 'center'},
              {binding: 'cltcd', header: 'ì½”ë“œ', width: 140, minWidth: 80, align: 'center'},
              {binding: 'cltnm', header: 'ê±°ë˜ì²˜ëª…', width: 250 },
              {binding: 'telnum', header: 'ì „í™”', width: 250},
              {binding: 'cltadres', header: 'ì£¼ì†Œ', width: '*'}
            ],
            itemsSource: viewdata
          });
          modalGrid.rowHeaders.columns.splice(0, 1);
          console.log('Modal grid initialized and data loaded.');

          // ê·¸ë¦¬ë“œì˜ ë”ë¸” í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
          let lastClickTime = 0;
          modalGrid.hostElement.addEventListener('click', function (e) {
            const now = new Date().getTime();

            if (now - lastClickTime < 300) { // 300ms ì´ë‚´ì˜ ë‘ ë²ˆ í´ë¦­ì€ ë”ë¸” í´ë¦­ìœ¼ë¡œ ì¸ì‹
              // í´ë¦­ëœ ìœ„ì¹˜ì˜ í–‰ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸°
              const ht = modalGrid.hitTest(e);

              if (ht.cellType === wijmo.grid.CellType.Cell) {
                const clickedItem = modalGrid.rows[ht.row].dataItem;

                if (clickedItem && clickedItem.cltnm) { // í´ë¦­ëœ í–‰ì— 'cltnm' ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                  $('#searchCltnm').val(clickedItem.cltnm); // ê²€ìƒ‰ í•„ë“œì— ì—…ì²´ ì´ë¦„ ì„¤ì •
                }

                // ì›í•˜ëŠ” ê¸°ëŠ¥ ì‹¤í–‰
                searchButton(); // ë”ë¸” í´ë¦­ ì‹œ ì›í•˜ëŠ” í•¨ìˆ˜ ì‹¤í–‰
                closePopup('CltnmModal'); // ëª¨ë‹¬ ì°½ ë‹«ê¸°
              }
            }

            lastClickTime = now;
          });
        },
        error: function() {
          console.error("Error fetching modal data.");
        }
      });
    }

  </script>
</th:block>
</html>