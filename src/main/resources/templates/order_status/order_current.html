<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>
<th:block layout:fragment="content">

    <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>ì£¼ë¬¸ ì§„í–‰í˜„í™©</h2>
                <!--                <a href="#" title="ë¶ë§ˆí¬" class="bookmark toggle">-->
                <!--                    ë‚´ë©”ë‰´-->
                <!--                </a>-->
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ì£¼ë¬¸ í˜„í™©</li>
                <li>ì£¼ë¬¸ ì§„í–‰í˜„í™©</li>
            </ul>
        </div>
        <!-- Select -->
        <!--       ì£¼ë¬¸ë“±ë¡ íƒ­ ì¢…ë£Œ   / ì£¼ë¬¸ ì˜ë¢°í˜„í™© ì‹œì‘       -->
        <!-- Section -->
        <section class="tab-item" id="tab2" style="height: 832px;">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            ì£¼ë¬¸ì¼ì<span class="eq">*</span>
                        </dt>
                        <dd>
                            <ul class="date-box">
                                <li>
                                    <input type="date" id="startDate" name="startDate">
                                    <label for="startDate" class="hide">ì‹œì‘ì¼</label>
                                </li>
                                ~
                                <li>
                                    <input type="date" id="endDate" name="endDate">
                                    <label for="endDate" class="hide">ì¢…ë£Œì¼</label>
                                </li>
                            </ul>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="searchComnm">
                                í˜„ì¥ëª…<span class="eq">*</span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input type="text" id="searchComnm" name="searchComnm" class="input-srch"
                                       placeholder="í˜„ì¥ëª…" style="border-radius: 5px;" readonly>
                                <!--                                        <a href="#a" class="btn-srch" title="ê²€ìƒ‰" onclick="searchData()"></a>-->
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="searchRemark">
                                ë„ë²ˆ<span class="eq">*</span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input type="text" id="searchRemark" name="searchRemark" class="input-srch"
                                       placeholder="ë„ë²ˆ" style="border-radius: 5px;">
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="searchOrdflag">
                                ì§„í–‰êµ¬ë¶„<span class="eq">*</span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select id="searchOrdflag" name="searchOrdflag">
                                    <option value="">ì „ì²´</option>
                                    <option value="0">ì£¼ë¬¸ë“±ë¡</option>
                                    <option value="1">ì£¼ë¬¸í™•ì¸</option>
                                    <option value="2">ì£¼ë¬¸í™•ì •</option>
                                    <option value="3">ì œì‘ì§„í–‰</option>
                                    <option value="4">ì¶œê³ </option>
                                    <option value="5">ì£¼ë¬¸ì·¨ì†Œ</option>
                                </select>
                                <!--                                        <a href="#a" class="btn-srch" title="ê²€ìƒ‰" onclick="searchData()"></a>-->
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="searchButton1" onclick="fetchListData()">
                                    <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    ê²€ìƒ‰
                                </a>
                            </li>
                        </dd>
                    </dl>
                    <dl>
                        <dd>
                            <li>
                                <button>ì¶œí•˜ ë° ì¸ìˆ˜í™•ì¸ì„œ</button>
                            </li>
                        </dd>
                    </dl>
                    <dl>
                        <dd>
                            <li>
                                <button>ê±°ë˜ëª…ì„¸ì„œ</button>
                            </li>
                        </dd>
                    </dl>
                </div>
            </div>
            <div class="container-fluid">
                <p id="selectedItem"></p>
                <div id="theGrid" style="max-height: 714px"></div>
            </div>
        </section>
    </div> <!--//layout-contents end -->
    <footer style="margin-top:5px;">
        <p>Copyrightâ“’ 0000 corp. All rights reserved.</p>
    </footer>
    <div style="height: 10px"></div>

    <div class="modal">
        <div class="popup-wrapper w700" id="popup1">
            <div class="popup-title">
                <h3>íŒŒì¼ ì—…ë¡œë“œ</h3>
                <a title="íŒì—…ë‹«ê¸°" onclick="closePopup('popup1')" class="btn-popup-close">
                    <img src="/images/icon/btn-popup-close.svg" alt="ë‹«ê¸°">
                </a>
            </div>
            <div class="popup-contents">
                <div class="table-wrap">
                    <table class="write-table">
                        <caption>ì „ê¸°ì•ˆì „ ì ê²€ ì²¨ë¶€íŒŒì¼</caption>
                        <colgroup>
                            <col class="wp20">
                            <col class="wp80">
                        </colgroup>
                        <tbody>
                        <tr>
                            <th>
                                ì²¨ë¶€íŒŒì¼
                            </th>
                            <td>
                                <div id="uploadComponent2" class="upload-component2">
                                    <div class="upload-filebox2">
                                        <img src="/images/icon/ico-fileupload.svg" alt="ì—…ë¡œë“œì•„ì´ì½˜">
                                        <a class="btn" title="íŒŒì¼ì—…ë¡œë“œ">íŒŒì¼ ì—…ë¡œë“œ</a>
                                        <input type="file" id="fileInput2" class="fileInput2" multiple>
                                        <p>Maximun upload file size <span>1GiB</span></p>
                                    </div>

                                    <div class="upload-filelist2">
                                        <div class="title">
                                            <h5>Files (0)</h5>
                                            <a title="Delete all" class="btn-file-deleteall2">Delete all</a>
                                        </div>
                                        <ul class="filelist2" id="filelist2">
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="popup-button">
                    <button type="button" onclick="closePopup('popup1')" class="btn-navy">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>
    <!--ìš”ì²­ì‚¬í•­ popup -->
    <div class="modal">
        <div class="popup-wrapper w700" id="popup2" style="min-width: 1050px">
            <div class="popup-title">
                <h3>ì˜µì…˜ ë° ìš”ì²­ì‚¬í•­</h3>
                <a title="íŒì—…ë‹«ê¸°" onclick="closePopup('popup2')" class="btn-popup-close">
                    <img src="/images/icon/btn-popup-close.svg" alt="ë‹«ê¸°">
                </a>
            </div>
            <div class="popup-contents">
                <div class="table-wrap">
                    <colgroup>
                        <col class="wp20">
                        <col class="wp80">
                    </colgroup>
                    <div class="table-wrap">
                        <table class="write-table">
                            <caption>ìš”ì²­ì‚¬í•­</caption>
                            <tbody>
                            <tr style="align-items: center">
                                <th>
                                    <label for="ordtext">
                                        ë‚´&nbsp;&nbsp;ìš©
                                    </label>
                                </th>
                                <td colspan="3">
                                    <div class="textarea-box">
                                        <textarea id="ordtext" style="height: 300px"></textarea>
                                        <!--<p class="text-count" id="text-count">0/100</p>-->
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <a style="color: red;margin-top: 4px;margin-left: 5px;">&nbsp;&nbsp;(ì²¨ë¶€íŒŒì¼ ë° ì´ë¯¸ì§€ëŠ” íŒŒì¼ì²¨ë¶€ë¥¼ ì´ìš©í•˜ì—¬ ì£¼ì„¸ìš”)</a>
                    </div>
                </div>
                <div class="popup-button">
                    <button type="button" onclick="endtext('popup2')" class="btn-navy">ì‘ì„±ì™„ë£Œ</button>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <script type="text/javascript">

        var theGrid;
        var theGrid2;
        var viewdata1;
        var viewdata2;
        let SelectItem;
        let csrfToken = $("[name=_csrf]").val();

        document.readyState === 'complete' ? init() : window.onload = init;

        // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
        const date = new Date();
        date.setHours(date.getHours() + 9); // UTC+9ë¡œ í•œêµ­ ì‹œê°„ ì„¤ì •
        const today = date.toISOString().split('T')[0];

        // í˜„ì¬ ë…„ë„ì™€ ì›”ì„ ê°€ì ¸ì˜µë‹ˆë‹¤
        const currentYear = date.getFullYear();
        const currentMonth = (date.getMonth() + 1).toString().padStart(2, '0'); // 1ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1 ì²˜ë¦¬

        // ì´ë²ˆ ë‹¬ 1ì¼ì„ ì„¤ì •
        const firstDayOfMonth = `${currentYear}-${currentMonth}-01`;

        // input ê°’ ì„¤ì •
        document.getElementById('startDate').value = firstDayOfMonth;
        document.getElementById('endDate').value = today;
        document.getElementById('reqdate').value = today;

        <!-- ì´ˆë°˜ í˜ì´ì§€ ì§„ì…ì‹œ ê·¸ë¦¬ë“œ ë°”ì¸ë”© ë-->
        function init() {
            // ğŸ”¹ sessionStorageì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const rowData = sessionStorage.getItem("selectedRowData");
            const tabAction = sessionStorage.getItem("tabAction"); // âœ… ì¶”ê°€: tabAction ê°’ ê°€ì ¸ì˜¤ê¸°
            const sessionDate = sessionStorage.getItem("sessionDate");

            if (rowData) {
                // ğŸ”¹ JSON íŒŒì‹±í•˜ì—¬ ë°ì´í„° ì¶”ì¶œ
                const parsedData = JSON.parse(rowData);
                console.log("âœ… sessionStorage ë°ì´í„° ìˆìŒ:", parsedData);

                // í•„ìš”í•œ ê°’ë“¤ ì¶”ì¶œ
                const { saupnum, reqnum, reqdate, cltnm } = parsedData;

                console.log("ì‚¬ì—…ìë²ˆí˜¸ (saupnum):", saupnum);
                document.getElementById("saupnumHidden").value = saupnum;
                document.getElementById("reqnum").value = reqnum;
                document.getElementById("reqdate").value = reqdate;
                document.getElementById("searchComnm").value = cltnm;
                document.getElementById("startDate").value = reqdate;
                document.getElementById("endDate").value = reqdate;
                // `saupnum`ì„ í¬í•¨í•´ì„œ ë°ì´í„° ìš”ì²­
                // ì—…ì²´ëª… readonly ì œê±°
                document.getElementById("searchComnm").removeAttribute("readonly");
                // ì‹ ê·œë“±ë¡ë²„íŠ¼ ì œê±°
                document.getElementById("newdataBtn").style.display = "none";
                //`saupnum`ì„ í¬í•¨í•´ì„œ ë°ì´í„° ìš”ì²­
                fetchListData(saupnum);
                fetchListData2(saupnum);
                getMyInfo(saupnum);
                activateSection();

                // 2ì´ˆ í›„ì— sessionStorage ë°ì´í„° ì‚­ì œ
                setTimeout(() => {
                    sessionStorage.removeItem("selectedRowData");
                    console.log("ğŸ—‘ï¸ sessionStorage ë°ì´í„° ì‚­ì œ ì™„ë£Œ");
                }, 2000);
            } else {
                if(sessionDate != null){
                    document.getElementById("startDate").value = sessionDate;
                    document.getElementById("endDate").value = sessionDate;
                }
                console.warn("âš ï¸ sessionStorageì— ì €ì¥ëœ ë°ì´í„° ì—†ìŒ. ê¸°ë³¸ ìš”ì²­ ì‹¤í–‰");

                // ğŸ”¹ ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ ì‹¤í–‰ (ì¸ì ì—†ì´)
                async function fetchData() {
                    try {
                        await getMyInfo();   // âœ… getMyInfo()ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
                        fetchListData();  // âœ… getMyInfo ì™„ë£Œ í›„ ì‹¤í–‰
                        fetchListData2(); // âœ… fetchListData ì™„ë£Œ í›„ ì‹¤í–‰
                    } catch (error) {
                        console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
                    }
                }
                // ì‹¤í–‰
                fetchData();
            }

            // âœ… tabAction ê°’ì´ ìˆìœ¼ë©´ ì‹¤í–‰ í›„ ì‚­ì œ
            if (tabAction) {
                setTimeout(() => {
                    console.log("ğŸ”„ tabAction ê°’ ì¡´ì¬, init ì‹¤í–‰!");
                    sessionStorage.removeItem("tabAction"); // ì‹¤í–‰ í›„ ì œê±°
                    sessionStorage.removeItem("selectedRowData");
                    sessionStorage.removeItem("sessionDate")
                    console.log("ğŸ—‘ï¸ sessionStorage.tabAction ë°ì´í„° ì‚­ì œ ì™„ë£Œ");
                }, 2000);
            }
        }

        // âœ… íƒ­ì´ í™œì„±í™”ë  ë•Œ `tabAction` ê°’ì„ í™•ì¸í•˜ê³  `init()` ì‹¤í–‰
        window.addEventListener("storage", function (event) {
            if (event.key === "tabAction" && event.newValue) {
                console.log("ğŸ“¢ tabAction ê°ì§€ë¨! init ì‹¤í–‰");
                init();
            }
        });

        function activateSection() {
            $(".tab-item").hide(); // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            $("#tab1").show(); // í•´ë‹¹ ì„¹ì…˜ í‘œì‹œ
            $(".tab-links li").removeClass("active"); // ëª¨ë“  íƒ­ì—ì„œ active ì œê±°

            // íŠ¹ì • titleì„ ê°€ì§„ <a> íƒœê·¸ë¥¼ ì°¾ì•„ í•´ë‹¹ <li>ì— active ì¶”ê°€
            $(".tab-links a[title='ì£¼ë¬¸ ë“±ë¡']").parent("li").addClass("active");
        }

        // ì£¼ë¬¸í˜„í™© ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ê¸°ì¡´íƒ­ ìµœì‹ í™”
        document.addEventListener("DOMContentLoaded", function () {
            console.log("âœ… order_request.html DOMContentLoaded ì™„ë£Œ");

            window.addEventListener("message", function (event) {
                console.log("ğŸ“© ë©”ì‹œì§€ ìˆ˜ì‹ ! Origin:", event.origin);
                console.log("ğŸ“© ë©”ì‹œì§€ ë‚´ìš©:", event.data);

                if (event.data.action === "init") {
                    console.log("ğŸ“© init ì‹¤í–‰ ìš”ì²­ ë°›ìŒ");
                    init(); // `init()` í•¨ìˆ˜ ì‹¤í–‰
                }
            });

            // index.htmlì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€ê°€ iframeì´ ë¡œë“œë˜ê¸° ì „ì— ë„ì°©í–ˆì„ ê²½ìš° ëŒ€ë¹„
            setTimeout(() => {
                window.parent.postMessage({ action: "requestInit" }, "*");
            }, 200);
        });


        // ì£¼ë¬¸/ì§„í–‰í˜„í™© ê·¸ë¦¬ë“œ
        function fetchListData(saupnum) {
            let data2 = [];
            const transformedData = []; // ë³€í™˜ëœ ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´
            $.ajax({
                url: '/api/request/request/order_read',
                type: 'GET',
                data: {
                    'saupnum':saupnum,
                    'saupnumHidden': $('#saupnumHidden').val(),
                    'search_startDate': $('#startDate').val(),
                    'search_endDate': $('#endDate').val(),
                    'search_remark': $('#searchRemark').val(),
                    'search_ordflag': $('#searchOrdflag').val(),
                    'search_comnm': $('#searchComnm').val()
                },
                async: false,
                success: function (data) {
                    data2 = data.data;
                }
            })
            // bd_detailsë¥¼ íŒŒì‹±í•˜ì—¬ ë°°ì—´ë¡œ ë³€í™˜
            // bd_detailsê°€ ìœ íš¨í•œ JSON ë¬¸ìì—´ì¼ ë•Œë§Œ íŒŒì‹±

            const seenReqnum = new Set(); // reqnumì„ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µì„ í™•ì¸
            data2.forEach(item => {
                item.bd_hgrb = getHgrb((item.bd_hgrb));
                item.bd_exfmtypedv = getListCgrb2(item.bd_exfmtypedv);
                item.bd_infmtypedv = getListCgrb2(item.bd_infmtypedv);
                item.bd_stframedv = getListCgrb2(item.bd_stframedv);
                item.bd_stexplydv = getListCgrb2(item.bd_stexplydv);
                item.originOrdtext = item.bd_ordtext;
            });
            viewdata1 = new wijmo.collections.CollectionView(data2); // ë³€í™˜ëœ ë°ì´í„°ë¥¼ CollectionViewë¡œ ë³€í™˜
            const minRows = 12; // ìµœì†Œ í–‰ ìˆ˜
            const rowTemplate = {
                ordflag: null,
                reqdate: null,
                deldate: null,
                panel_ht: null,
                panel_hw: null,
                panel_hl: null,
                panel_hh: null,
                remark: null,
                downloads: null,
                bd_hgrb: null,
                bd_qty: null,
                bd_panel_t: null,
                bd_panel_w: null,
                bd_panel_l: null,
                bd_exfmtypedv: null,
                bd_infmtypedv: null,
                bd_stframedv: null,
                bd_stexplydv: null,
                bd_ordtext: null,
                telno: null,
                perid: null,
                cltaddr: null,
                reqnum: null,
                isdownload: null,
                hd_files: null,
                saupnum:null,
                originOrdtext: null
            }; // í•„ìš”í•œ ë°ì´í„° êµ¬ì¡°

// ë¹ˆ í–‰ ì¶”ê°€
            while (viewdata1.sourceCollection.length < minRows) {
                viewdata1.sourceCollection.push({ ...rowTemplate });
            }

            if (!theGrid) {
                // ë°ì´í„° ê·¸ë¦¬ë“œì— ë°”ì¸ë”©
                theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    columns: [
                        {binding: 'ordflag', header: 'ì§„í–‰êµ¬ë¶„', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'cltnm', header: 'ì—…ì²´ëª…', width: '*', minWidth: 105, align: 'center'},
                        {binding: 'reqdate', header: 'ì£¼ë¬¸ì¼ì', width: '*', minWidth: 120, align: 'center'},
                        {binding: 'deldate', header: 'ë‚©í’ˆí¬ë§ì¼', width: '*', minWidth: 120, align: 'center'},
                        {binding: 'panel_ht', header: 'ë‘ê»˜', width: '*', minWidth: 70, align: 'right'},
                        {binding: 'panel_hw', header: 'í­', width: '*', minWidth: 70, align: 'right'},
                        {binding: 'panel_hl', header: 'ê¸¸ì´', width: '*', minWidth: 70, align: 'right'},
                        {binding: 'panel_hh', header: 'ë†’ì´', width: '*', minWidth: 70, align: 'right'},
                        {binding: 'remark', header: 'ì œëª©', width: '*', minWidth: 250, align: 'left'},
                        {binding: 'downloads', header: 'ì²¨ë¶€íŒŒì¼', width: '*', minWidth: 105, align: 'center'},

                        {binding: 'reqnum', visible: false},  // ìˆ¨ê¸¸ ì»¬ëŸ¼
                        {binding: 'isdownload', visible: false},
                        {binding: 'hd_files', visible: false},
                        {binding: 'originOrdtext', visible: false},
                        {binding: 'saupnum', visible: false},
                    ],
                    itemsSource: viewdata1,
                    itemFormatter: function (panel, r, c, cell) {
                        if (panel.cellType === wijmo.grid.CellType.Cell) {
                            var item = panel.rows[r].dataItem; // í˜„ì¬ í–‰ì˜ ë°ì´í„° í•­ëª©
                            if (panel.columns[c].binding === 'downloads') {
                                cell.innerHTML = ''; // ì…€ ë‚´ìš© ì´ˆê¸°í™”
                                if (item.isdownload) {
                                    cell.innerHTML = '<a title="ë‹¤ìš´ë¡œë“œ" class="btn-filedown" onclick="downloadFile_order()">ë‹¤ìš´ë¡œë“œ</a>';
                                }
                            }
                            if (panel.columns[c].binding === 'bd_ordtext') {
                                if (item.bd_ordtext) {
                                    cell.innerHTML = '<a title="ìˆ˜ì •íŒì—…" class="" onclick="showPopup2(\'popup2\')" style="color: #03428E">ìš”ì²­ì‚¬í•­ í™•ì¸</a>';
                                }
                            }
                        }
                    }
                });
                // í—¤ë”ë¥¼ ì¤‘ì•™ ì •ë ¬í•˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                theGrid.formatItem.addHandler(function (s, e) {
                    if (e.panel === s.columnHeaders) {
                        e.cell.style.textAlign = 'center';
                    }
                });
                // ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸
                theGrid.hostElement.addEventListener('dblclick', function (e) {
                    // ê·¸ë¦¬ë“œì˜ ì…€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    let hitTest = theGrid.hitTest(e);
                    if (hitTest.cellType === wijmo.grid.CellType.Cell) {
                        // í–‰(row), í–‰ì˜ ë°ì´í„°(item) ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                        let row = hitTest.row;
                        let item = theGrid.rows[row].dataItem;
                        if (!item.ordflag && item.reqnum) {
                            let hdRow = viewdata1.items.find(data => data.reqnum === item.reqnum && data.ordflag);
                            if (hdRow) {
                                document.getElementById('reqdate').value = hdRow.reqdate;
                                document.getElementById('deldate').value = hdRow.deldate;
                                document.getElementById('telno').value = hdRow.telno;
                                document.getElementById('perid').value = hdRow.perid;
                                document.getElementById('postno').value = hdRow.cltzipcd;
                                document.getElementById('address1').value = hdRow.cltaddr;
                                document.getElementById('panel_ht').value = hdRow.panel_ht;
                                document.getElementById('panel_hw').value = hdRow.panel_hw;
                                document.getElementById('panel_hl').value = hdRow.panel_hl;
                                document.getElementById('panel_hh').value = hdRow.panel_hh;
                                document.getElementById('remark').value = hdRow.remark;
                            }
                        }else {
                            document.getElementById('reqdate').value = item.reqdate;
                            document.getElementById('deldate').value = item.deldate;
                            document.getElementById('telno').value = item.telno;
                            document.getElementById('perid').value = item.perid;
                            document.getElementById('postno').value = item.cltzipcd;
                            document.getElementById('address1').value = item.cltaddr;
                            document.getElementById('panel_ht').value = item.panel_ht;
                            document.getElementById('panel_hw').value = item.panel_hw;
                            document.getElementById('panel_hl').value = item.panel_hl;
                            document.getElementById('panel_hh').value = item.panel_hh;
                            document.getElementById('remark').value = item.remark;
                        }
                        let fileList = Array.isArray(item.hd_files) ? item.hd_files : [];

                        deletedFiles2 = [];
                        uploadedFiles2 = [];

                        fileList.forEach(file => {
                            let newFile = {
                                name: file.fileornm,
                                type: file.fileextns,
                                size: file.filesize,
                                fileid: file.fileid,
                                reqseq: item.reqseq,
                                lastModified: new Date().getTime(),
                            };
                            uploadedFiles2.push(newFile); // íŒŒì¼ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                        });


                        $('.filelist2').empty(); // íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
                        updateFileCount2();
                        updateFileListUI2();

                        // document.getElementById('qty').value = item.bd_details.qty;
                        // document.getElementById('panel_t').value = item.bd_details.panel_t;
                        // document.getElementById('panel_w').value = item.bd_details.panel_w;
                        // document.getElementById('panel_l').value = item.bd_details.panel_l;
                        // document.getElementById('ordtext').value = item.bd_details.ordtext;
                        //
                        // const selectHgrb = document.getElementById('hgrb');
                        // const selectExfmtypedv = document.getElementById('exfmtypedv');
                        // const selectInfmtypedv = document.getElementById('infmtypedv');
                        // const selectStframedv = document.getElementById('stframedv');
                        // const selectStexplydv = document.getElementById('stexplydv');
                        //
                        // const selectedItem = item;
                        //
                        // setSelectedIndex(selectHgrb, selectedItem.bd_details.hgrb);
                        // setSelectedIndex(selectExfmtypedv, selectedItem.bd_details.exfmtypedv);
                        // setSelectedIndex(selectInfmtypedv, selectedItem.bd_details.infmtypedv);
                        // setSelectedIndex(selectStframedv, selectedItem.bd_details.stframedv);
                        // setSelectedIndex(selectStexplydv, selectedItem.bd_details.stexplydv);
                        document.getElementById('btnSave').title = "ìˆ˜ì •";
                        document.getElementById('reqnum').value = item.reqnum;
                        resetBodyField();
                        const tab1Link = document.getElementById('listTabLink');
                        tab1Link.click();
                        fetchListData2();
                    }
                })
                // FlexGridì˜ ìµœëŒ€ ë†’ì´ë¥¼ ì œí•œí•˜ì—¬ ìŠ¤í¬ë¡¤ë°”ë¥¼ í™œì„±í™”
                theGrid.hostElement.style.maxHeight = '650px'; // ì•½ 12ê°œì˜ í–‰ ë†’ì´ì— ë§ê²Œ ì„¤ì •
                theGrid.hostElement.style.overflowY = 'auto';
                // ì„ íƒì´ ë³€ê²½ë  ë•Œ, í˜„ì¬ í•­ëª© ì—…ë°ì´íŠ¸
                theGrid.rowHeaders.columns.splice(0, 1);  //ë§¨ ì•ì— í—¤ë”ë¶€ë¶„ ì—†ì• ê¸°
                new FlexGridContextMenu(theGrid);
                window.downloadFileName = 'ì£¼ë¬¸ë“±ë¡ ì²¨ë¶€íŒŒì¼';
            } else {
                // ì´ë¯¸ FlexGridì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°, ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸
                theGrid.itemsSource = viewdata1;
            }
        }

        // ì£¼ë¬¸ë“±ë¡ ì„¸ë¶€ë‚´ìš© ê·¸ë¦¬ë“œ
        function fetchListData2(saupnum) {
            let data2 = [];

            $.ajax({
                url: '/api/request/request/read',
                type: 'GET',
                data: {
                    'saupnumHidden': $('#saupnumHidden').val(),
                    'saupnum':saupnum,
                    'reqnum': $('#reqnum').val(),
                    'reqdate': $('#reqdate').val()
                },
                async: false,
                success: function (data) {
                    data2 = data.data;
                    data2.forEach(item =>{
                        item.hgrb = getHgrb((item.hgrb));
                        item.exfmtypedv = getListCgrb2(item.exfmtypedv);
                        item.infmtypedv = getListCgrb2(item.infmtypedv);
                        item.stframedv = getListCgrb2(item.stframedv);
                        item.stexplydv = getListCgrb2(item.stexplydv);
                        item.originOrdtext = item.ordtext;
                    })
                }
            })

            viewdata2 = new wijmo.collections.CollectionView(data2);

            if (!theGrid2) {

                // ë°ì´í„° ê·¸ë¦¬ë“œì— ë°”ì¸ë”©
                theGrid2 = new wijmo.grid.FlexGrid('#theGrid2', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    columns: [
                        {binding: 'hgrb', header: 'ì œí’ˆêµ¬ì„±', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'qty', header: 'ìˆ˜ëŸ‰', width: 80, align: 'right'},
                        {binding: 'panel_t', header: 'T', width: 80, align: 'right'},
                        {binding: 'panel_w', header: 'W/H', width: 80, align: 'right'},
                        {binding: 'panel_l', header: 'L', width: 80, align: 'right'},
                        {binding: 'exfmtypedv', header: 'ì™¸ë¶€ë§ˆê°ì¬', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'infmtypedv', header: 'ì™¸ë¶€ë³´ê°•ì¬', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'stframedv', header: 'ë‚´ë¶€ë³´ê°•ì¬', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'stexplydv', header: 'ë‚´ë¶€ë§ˆê°ì¬', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'ordtext', header: 'ì˜µì…˜ ë° ìš”ì²­ì‚¬í•­', width: '*', minWidth: 100, align: 'left'},
                        {binding: 'originOrdtext', visible: false},
                        {binding: 'reqseq', visible: false},
                        {binding: 'isnew', visible: false},
                        {binding: 'saupnum',visible: false}
                    ],
                    itemsSource: viewdata2,
                    itemFormatter: function (panel, r, c, cell) {
                        if (panel.cellType === wijmo.grid.CellType.Cell) {
                            var item = panel.rows[r].dataItem; // í˜„ì¬ í–‰ì˜ ë°ì´í„° í•­ëª©
                            if (panel.columns[c].binding === 'ordtext') {
                                cell.innerHTML = ''; // ì…€ ë‚´ìš© ì´ˆê¸°í™”
                                if (item.ordtext) {
                                    cell.innerHTML = '<a title="ìˆ˜ì •íŒì—…" class="" onclick="showPopup3(\'popup2\')" style="color: #03428E">ìš”ì²­ì‚¬í•­ í™•ì¸</a>';
                                }
                            }
                        }
                    }
                });
                // í—¤ë”ë¥¼ ì¤‘ì•™ ì •ë ¬í•˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                theGrid2.formatItem.addHandler(function (s, e) {
                    if (e.panel === s.columnHeaders) {
                        e.cell.style.textAlign = 'center';
                    }
                });
                // ì²«ì—´ì— selectBox ì¶”ê°€
                let selector = new wijmo.grid.selector.Selector(theGrid2, {
                    itemChecked: (e, ctx) => {
                        SelectItem = theGrid2.rows.filter(r => r.isSelected);

                    }
                })
                // ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸
                theGrid2.hostElement.addEventListener('dblclick', function (e) {
                    // ê·¸ë¦¬ë“œì˜ ì…€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    let hitTest = theGrid2.hitTest(e);
                    if (hitTest.cellType === wijmo.grid.CellType.Cell) {
                        // í–‰(row), í–‰ì˜ ë°ì´í„°(item) ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                        let row = hitTest.row;
                        let item = theGrid2.rows[row].dataItem;

                        document.getElementById('qty').value = item.qty;
                        document.getElementById('panel_t').value = item.panel_t;
                        document.getElementById('panel_w').value = item.panel_w;
                        document.getElementById('panel_l').value = item.panel_l;
                        document.getElementById('reqseq').value = item.reqseq;
                        document.getElementById('isnew').value = item.isnew;
                        document.getElementById('ordtext').value = item.ordtext;

                        const selectHgrb = document.getElementById('hgrb');
                        const selectExfmtypedv = document.getElementById('exfmtypedv');
                        const selectInfmtypedv = document.getElementById('infmtypedv');
                        const selectStframedv = document.getElementById('stframedv');
                        const selectStexplydv = document.getElementById('stexplydv');

                        const selectedItem = item;

                        setSelectedIndex(selectHgrb, selectedItem.hgrb);
                        setSelectedIndex(selectExfmtypedv, selectedItem.exfmtypedv);
                        setSelectedIndex(selectInfmtypedv, selectedItem.infmtypedv);
                        setSelectedIndex(selectStframedv, selectedItem.stframedv);
                        setSelectedIndex(selectStexplydv, selectedItem.stexplydv);
                    }
                })
                // FlexGridì˜ ìµœëŒ€ ë†’ì´ë¥¼ ì œí•œí•˜ì—¬ ìŠ¤í¬ë¡¤ë°”ë¥¼ í™œì„±í™”
                theGrid2.hostElement.style.maxHeight = '300px'; // ì•½ 5ê°œì˜ í–‰ ë†’ì´ì— ë§ê²Œ ì„¤ì •
                theGrid2.hostElement.style.overflowY = 'auto';
                // ì„ íƒì´ ë³€ê²½ë  ë•Œ, í˜„ì¬ í•­ëª© ì—…ë°ì´íŠ¸
                new FlexGridContextMenu(theGrid2);
                window.downloadFileName = 'ì£¼ë¬¸ë“±ë¡';
            } else {
                // ì´ë¯¸ FlexGridì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°, ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸
                theGrid2.itemsSource = viewdata2;
            }
        }

    </script>

</th:block>
</html>

