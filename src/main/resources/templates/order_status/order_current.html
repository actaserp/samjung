<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>
<th:block layout:fragment="content">

    <!--- (레이아웃) Contents 영역 -->
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>주문 진행현황</h2>
                <!--                <a href="#" title="북마크" class="bookmark toggle">-->
                <!--                    내메뉴-->
                <!--                </a>-->
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>주문 현황</li>
                <li>주문 진행현황</li>
            </ul>
        </div>
        <!-- Select -->
        <!--       주문등록 탭 종료   / 주문 의뢰현황 시작       -->
        <!-- Section -->
        <section class="tab-item" id="tab2" style="height: 832px;">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            주문일자<span class="eq">*</span>
                        </dt>
                        <dd>
                            <ul class="date-box">
                                <li>
                                    <input type="date" id="startDate" name="startDate">
                                    <label for="startDate" class="hide">시작일</label>
                                </li>
                                ~
                                <li>
                                    <input type="date" id="endDate" name="endDate">
                                    <label for="endDate" class="hide">종료일</label>
                                </li>
                            </ul>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="searchActnm">
                                현장명<span class="eq">*</span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input type="text" id="searchActnm" name="searchActnm" class="input-srch"
                                       placeholder="현장명" style="border-radius: 5px;">
                                <!--                                        <a href="#a" class="btn-srch" title="검색" onclick="searchData()"></a>-->
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="searchChulflag">
                                진행구분<span class="eq">*</span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select id="searchChulflag" name="searchChulflag" style="border-radius: 5px 5px 5px 5px;">
                                    <option value=""></option>
                                </select>
                                <!--                                        <a href="#a" class="btn-srch" title="검색" onclick="searchData()"></a>-->
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="검색" id="searchButton1" onclick="onclickSearchButton1()">
                                    <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                    <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                    검색
                                </a>
                            </li>
                        </dd>
                    </dl>
                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="저장" id="deliverySave" onclick="deliverySave()">
                                    <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                    <img src="/images/icon/ico-save.svg" alt="저장 아이콘">
                                    저장
                                </a>
                            </li>
                        </dd>
                    </dl>
                    <dl style="margin-left: auto;">
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <button id="deliveryBtn" onclick="deliveryDoc()">출하 및 인수확인서</button>
                            </li>
                        </dd>
                    </dl>
                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <button id="provBtn" onclick="provDoc()">거래명세서</button>
                            </li>
                        </dd>
                    </dl>
                </div>
            </div>
            <div class="container-fluid">
                <p id="selectedItem"></p>
                <div id="theGrid" style="max-height: 714px"></div>
            </div>
        </section>
    </div> <!--//layout-contents end -->
    <footer style="margin-top:5px;">
        <p>Copyrightⓒ 0000 corp. All rights reserved.</p>
    </footer>
    <div style="height: 10px"></div>
    <div class="dashboard-layout-popup">
        <div class="popup-overlay" id="popup1"></div>
        <div class="popup-wrapper" id="wrapper1">
            <div class="popup-title">
                <h3>파일 미리보기</h3>
                <input type="hidden" id="searchExcelType" value="">
                <a onclick="NewClose()" title="팝업닫기" class="btn-popup-close">
                    <img src="/images/icon/btn-popup-close.svg" alt="닫기">
                </a>
            </div>
            <div class="popup-contents">
                <form id="searchExcelForm" autocomplete="off">
                    <div class="table-wrap">
                        <table class="view-table" id="selectedData" style="max-height: 740px;">
                            <caption>파일 미리보기</caption>
                            <colgroup>
                                <col class="wp20">
                                <col class="wauto">
                                <col class="wp20">
                                <col class="wauto">
                            </colgroup>
                            <tbody>
                            <tr >
                                <!--                <th>전표 보기</th>-->
                                <th>출고일</th>
                                <td colspan="">
                                    <input type="date" id="popupDate">
                                </td>
                                <td>
                                    <button type="button" id="searchExcelBtn" style="background-color: #0a68b4; color: #FFFFFF; width: 100% " onclick="modifyData()">조회</button>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="5">
                                    <div id="pdfWrapper" style="display: flex;">
                                        <div id="pdfView" class="tab-item wp100" style="display: block;">
                                            <div id="pdfContainer" style="
                              width: 100%;
                              height: auto;
                              padding: 10px;
                              background: #f8f9fa;
                              overflow-y: auto;
                              max-height: 500px;">
                                                <!-- PDF 페이지가 동적으로 추가됩니다. -->
                                                <div id="loadingSpinner" style="display: none;">
                                                    <div class="spinner"></div>
                                                    <p>PDF를 불러오는 중입니다...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="popup-button">
                <button type="button" class="btn-navy btn-reject" onclick="downloadFile('reject')">다운로드</button>
                <button type="button" class="btn-popup-close" onclick="NewClose()">종료</button>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script><!-- PDF.js 라이브러리 추가 -->
    <script type="text/javascript">

        var theGrid;
        var viewdata1;
        let SelectItem;
        let csrfToken = $("[name=_csrf]").val();

        // document.readyState === 'complete' ? init() : window.onload = init;

        // 오늘 날짜 설정
        const date = new Date();
        date.setHours(date.getHours() + 9); // UTC+9로 한국 시간 설정
        const today = date.toISOString().split('T')[0];

        // 현재 년도와 월을 가져옵니다
        const currentYear = date.getFullYear();
        const currentMonth = (date.getMonth() + 1).toString().padStart(2, '0'); // 1월은 0부터 시작하므로 +1 처리

        // 이번 달 1일을 설정
        const firstDayOfMonth = `${currentYear}-${currentMonth}-01`;

        // input 값 설정
        document.getElementById('startDate').value = firstDayOfMonth;
        document.getElementById('endDate').value = today;

        $(document).ready(function () {
            // 출고 진행구분 select option 바인드
            AjaxUtil.fillSelectOptions($('#searchChulflag'), 'system_code', 'all', false, 'delivery_type');
            fetchListData();
        });
        // 검색버튼 클릭 메서드
        function onclickSearchButton1(){
            // 필수 요소 안내 alert
            let requiredFields = [
                {id: '#searchActnm', label: '현장명을 작성해주세요'},
            ];
            for (let i = 0; i < requiredFields.length; i++) {
                let field = requiredFields[i];
                let $element = $(field.id);
                let value = $element.val();

                // 요소가 존재하지 않거나, 값이 빈 문자열(선택되지 않은 경우)인 경우 경고
                if ($element.length === 0 || value === null || value.trim() === '') {
                    Alert.alert('', field.label);
                    return;
                }
            }
            fetchListData();
        }
        // 주문출고 그리드
        function fetchListData(saupnum) {

            let data2 = [];
            const transformedData = []; // 변환된 데이터를 저장할 배열
            $.ajax({
                url: '/api/request/subRequest/order_read',
                type: 'GET',
                data: {
                    'saupnum': saupnum,
                    'search_startDate': $('#startDate').val(),
                    'search_endDate': $('#endDate').val(),
                    'search_chulflag': $('#searchChulflag').val(), // 진행구분
                    'search_actnm': $('#searchActnm').val() // 현장명
                },
                async: false,
                success: function (data) {
                    data2 = data.data;
                    if(data2 !== null){
                        data2.forEach(item => {
                            if (item.FACFLAG !== undefined && item.FACFLAG !== null) {
                                item.FACFLAG = Number(item.FACFLAG);
                            }
                        });
                    }else{
                        data2 = [];
                    }
                }
            })
            // bd_details를 파싱하여 배열로 변환
            // bd_details가 유효한 JSON 문자열일 때만 파싱

            const seenReqnum = new Set(); // reqnum을 기준으로 중복을 확인
            if (data2.length < 12){
                while (data2.length < 12) {
                    data2.push({'FACFLAG' : null});
                }
            }
            viewdata1 = new wijmo.collections.CollectionView(data2); // 변환된 데이터를 CollectionView로 변환
            if (!theGrid) {
                // 데이터 그리드에 바인딩
                theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: false,
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    columns: [
                        {binding: 'FACFLAG', header: '자재출고', width: '*', align: 'center', dataType: wijmo.DataType.Boolean},
                        {binding: 'FACDATE', header: '출하일자', width: '*', align: 'center'},
                        {binding: 'ACTNM', header: '현장명', width: '*', align: 'center'},
                        {binding: 'PNAME', header: '품명', width: '*', align: 'center'},
                        {binding: 'PSIZE', header: '규격', width: '*', align: 'center'},
                        {binding: 'PUNIT', header: '단위', width: '*', align: 'right'},
                        {binding: 'PQTY', header: '수량', width: '*', align: 'right'},
                        {binding: 'PUAMT', header: '단가', width: '*', align: 'right'},
                        {binding: 'PAMT', header: '금액', width: '*', align: 'right'},
                    ],
                    itemsSource: viewdata1,
                });
                theGrid.formatItem.addHandler(function (s, e) {
                    // 헤더를 중앙 정렬하는 이벤트 핸들러
                    if (e.panel === s.columnHeaders) {
                        e.cell.style.textAlign = 'center';
                    }
                    // FACFLAG 컬럼의 셀에서 값이 null일 경우 체크박스 숨김
                    if (e.panel === s.cells) {
                        var col = s.columns[e.col];
                        if (col.binding === 'FACFLAG') {
                            var item = s.rows[e.row].dataItem;
                            if (item && item.FACFLAG === null) {
                                e.cell.innerHTML = ''; // 셀을 비움 (체크박스 삭제)
                            }
                        }
                    }
                });
                // 편집 허용 제어 (이벤트 핸들러 추가)
                theGrid.beginningEdit.addHandler(function(s, e) {
                    // 컬럼 이름이 'FACFLAG'가 아니면 편집 막기
                    var col = s.columns[e.col];
                    if (col.binding !== 'FACFLAG') {
                        e.cancel = true; // 편집 취소!
                    }
                });
                // FlexGrid의 최대 높이를 제한하여 스크롤바를 활성화
                theGrid.hostElement.style.maxHeight = '650px'; // 약 12개의 행 높이에 맞게 설정
                theGrid.hostElement.style.overflowY = 'auto';
                // 선택이 변경될 때, 현재 항목 업데이트
                theGrid.rowHeaders.columns.splice(0, 1);  //맨 앞에 헤더부분 없애기
                new FlexGridContextMenu(theGrid);
                window.downloadFileName = '주문등록 첨부파일';
            } else {
                // 이미 FlexGrid이 존재하는 경우, 데이터만 업데이트
                theGrid.itemsSource = viewdata1;
            }
        }
        // 출하 및 인수확인서 클릭 메서드
        function deliveryDoc(){
            NewSave(); // 팝업 열기
            document.getElementById('searchExcelType').value = 'delivery';
        }
        // 거래명세서 클릭 메서드
        function provDoc(){
            NewSave(); // 팝업 열기
            document.getElementById('searchExcelType').value = 'prov';
        }
        function NewSave() {
            let popup = document.getElementById('popup1');
            let wrapper = document.getElementById('wrapper1');


            popup.style.display = 'block';
            wrapper.style.display = 'block';
        }
        // 프론트엔드 JavaScript PDF 렌더링
        function modifyData() {
            // 필수 요소 안내 alert
            let requiredFields = [
                {id: '#searchActnm', label: '현장명을 작성해주세요'},
                {id: '#popupDate', label: '시작일을 선택해주세요'},
            ];
            for (let i = 0; i < requiredFields.length; i++) {
                let field = requiredFields[i];
                let $element = $(field.id);
                let value = $element.val();

                // 요소가 존재하지 않거나, 값이 빈 문자열(선택되지 않은 경우)인 경우 경고
                if ($element.length === 0 || value === null || value.trim() === '') {
                    Alert.alert('', field.label);
                    return;
                }
            }
            const container = document.getElementById("pdfContainer");
            const spinner = document.getElementById("loadingSpinner");


            let searchDate = document.getElementById('popupDate').value;
            let excelType = document.getElementById('searchExcelType').value;
            let searchActnm = document.getElementById('searchActnm').value;
            // let spjangcd = document.getElementById('search_spjangcd').value;


            if(excelType === 'delivery') {
                // ✅ 이전 PDF 제거
                container.querySelectorAll("canvas").forEach(canvas => canvas.remove());

                // ✅ 스피너 표시 (PDF 전에)
                spinner.style.display = "flex";
                const url = `/api/request/subRequest/readVacFile`
                    + `?search_Date=${encodeURIComponent(searchDate)}`
                    + `&search_actnm=${encodeURIComponent(searchActnm)}`;
                //&spjangcd=${encodeURIComponent(spjangcd)}
                spinner.style.display = "flex"; // 스피너 보이기

                fetch(url)
                    .then(res => {
                        // PDF 아닌 경우 바로 catch
                        if (res.ok && res.headers.get("content-type").includes("pdf")) {
                            return res.blob();
                        } else {
                            throw new Error("PDF 생성 실패!");
                        }
                    })
                    .then(blob => {
                        console.log("PDF Blob size:", blob.size);
                        const blobURL = URL.createObjectURL(blob);
                        renderPdf(blobURL);
                    })
                    .catch(() => {
                        spinner.style.display = "none";
                        container.innerHTML = "<p style='color:red;'>휴가서 양식을 불러올 수 없습니다.</p>";
                    });
            }else if(excelType === 'prov'){
                // ✅ 이전 PDF 제거
                container.querySelectorAll("canvas").forEach(canvas => canvas.remove());

                // ✅ 스피너 표시 (PDF 전에)
                spinner.style.display = "flex";
                const url = `/api/request/subRequest/readVacFile2`
                    + `?search_Date=${encodeURIComponent(searchDate)}`
                    + `&search_actnm=${encodeURIComponent(searchActnm)}`;
                //&spjangcd=${encodeURIComponent(spjangcd)}
                spinner.style.display = "flex"; // 스피너 보이기

                fetch(url)
                    .then(res => {
                        // PDF 아닌 경우 바로 catch
                        if (res.ok && res.headers.get("content-type").includes("pdf")) {
                            return res.blob();
                        } else {
                            throw new Error("PDF 생성 실패!");
                        }
                    })
                    .then(blob => {
                        console.log("PDF Blob size:", blob.size);
                        const blobURL = URL.createObjectURL(blob);
                        renderPdf(blobURL);
                    })
                    .catch(() => {
                        spinner.style.display = "none";
                        container.innerHTML = "<p style='color:red;'>휴가서 양식을 불러올 수 없습니다.</p>";
                    });
            }
        }
        function renderPdf(url) {
            const container = document.getElementById("pdfContainer");
            const spinner = document.getElementById("loadingSpinner");
            // PDF 내용(canvas)만 지우고 스피너는 유지
            Array.from(container.querySelectorAll("canvas")).forEach(canvas => canvas.remove());
            spinner.style.display = "flex";

            pdfjsLib.getDocument({ url }).promise.then(pdf => {
                spinner.style.display = "none";
                console.log("PDF 페이지 개수:", pdf.numPages);
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    pdf.getPage(pageNum).then(page => {
                        const viewport = page.getViewport({ scale: 1.3 });
                        const canvas = document.createElement("canvas");
                        const context = canvas.getContext("2d");
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        container.appendChild(canvas);
                        page.render({
                            canvasContext: context,
                            viewport: viewport
                        });
                    }).catch(err => {
                        console.error("PDF 페이지 렌더링 실패:", err);
                    });
                }
            }).catch(error => {
                spinner.style.display = "none";
                console.error("❌ PDFjs getDocument 오류:", error);
                alert("PDF를 표시할 수 없습니다: " + error.message);
            });
        }
        // 자재출고 update 메서드
        function deliverySave(){
            const items = theGrid.itemsSource.items;
            const sendData = items
                .filter(item => item.FACFLAG !== null && item.BALJUNUM && item.BALJUSEQ) // null 제거, reqnum등 PK 포함
                .map(item => ({
                    BALJUNUM: item.BALJUNUM,
                    BALJUSEQ: item.BALJUSEQ,
                    FACFLAG: item.FACFLAG
                }));
            let data = {
                'sendData': JSON.stringify(sendData),
                '_csrf': csrfToken
            };

            let fnSuccess = function (res) {
                if (res.success) {
                    Alert.alert('', '출고상태가 변경되었습니다.');
                    fetchListData();
                }
            };
            AjaxUtil.postAsyncData('/api/request/subRequest/saveDelivery', data, fnSuccess);
        }
        // 엑셀파일 미리보기 팝업 닫기 메서드
        function NewClose() {
            // 팝업 닫기
            let popup = document.getElementById('popup1');
            let wrapper = document.getElementById('wrapper1');
            let spinner = document.getElementById('loadingSpinner');
            popup.style.display = 'none';
            wrapper.style.display = 'none';
            spinner.style.display = 'none';
        }
        // 엑셀파일 다운로드 메서드
        function downloadFile() {

        }
    </script>
</th:block>
</html>

