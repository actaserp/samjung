<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>
<th:block layout:fragment="content">

  <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>ì£¼ë¬¸ ì¶œê³ </h2>
        <!--                <a href="#" title="ë¶ë§ˆí¬" class="bookmark toggle">-->
        <!--                    ë‚´ë©”ë‰´-->
        <!--                </a>-->
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ì£¼ë¬¸ í˜„í™©</li>
        <li>ì£¼ë¬¸ ì¶œê³ </li>
      </ul>
    </div>
    <!-- Select -->
    <!--       ì£¼ë¬¸ë“±ë¡ íƒ­ ì¢…ë£Œ   / ì£¼ë¬¸ ì˜ë¢°í˜„í™© ì‹œì‘       -->
    <!-- Section -->
    <section class="tab-item" id="tab2" style="height: 832px;">
      <div class="section-top">
        <div class="search-wrap">
          <dl>
            <dt>
              ì£¼ë¬¸ì¼ì<span class="eq">*</span>
            </dt>
            <dd>
              <ul class="date-box">
                <li>
                  <input type="date" id="startDate" name="startDate">
                  <label for="startDate" class="hide">ì‹œì‘ì¼</label>
                </li>
                ~
                <li>
                  <input type="date" id="endDate" name="endDate">
                  <label for="endDate" class="hide">ì¢…ë£Œì¼</label>
                </li>
              </ul>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="searchComnm">
                í˜„ì¥ëª…<span class="eq">*</span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <input type="text" id="searchComnm" name="searchComnm" class="input-srch"
                       placeholder="í˜„ì¥ëª…" style="border-radius: 5px;">
                <!--                                        <a href="#a" class="btn-srch" title="ê²€ìƒ‰" onclick="searchData()"></a>-->
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="searchChulflag">
                ì§„í–‰êµ¬ë¶„<span class="eq">*</span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <select id="searchChulflag" name="searchChulflag" style="border-radius: 5px 5px 5px 5px;">
                  <option value=""></option>
                </select>
                <!--                                        <a href="#a" class="btn-srch" title="ê²€ìƒ‰" onclick="searchData()"></a>-->
              </div>
            </dd>
          </dl>
          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="ê²€ìƒ‰" id="searchButton1" onclick="fetchListData()">
                  <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                  ê²€ìƒ‰
                </a>
              </li>
            </dd>
          </dl>
          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="ì €ì¥" id="deliverySave" onclick="deliverySave()">
                  <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                  <img src="/images/icon/ico-save.svg" alt="ì €ì¥ ì•„ì´ì½˜">
                  ì €ì¥
                </a>
              </li>
            </dd>
          </dl>
          <dl>
            <dd>
              <li>
                <button id="deliveryBtn" onclick="deliveryDoc()">ì¶œí•˜ ë° ì¸ìˆ˜í™•ì¸ì„œ</button>
              </li>
            </dd>
          </dl>
          <dl>
            <dd>
              <li>
                <button id="provBtn" onclick="provDoc()">ê±°ë˜ëª…ì„¸ì„œ</button>
              </li>
            </dd>
          </dl>
        </div>
      </div>
      <div class="container-fluid">
        <p id="selectedItem"></p>
        <div id="theGrid" style="max-height: 714px"></div>
      </div>
    </section>
  </div> <!--//layout-contents end -->
  <footer style="margin-top:5px;">
    <p>Copyrightâ“’ 0000 corp. All rights reserved.</p>
  </footer>
  <div style="height: 10px"></div>
  <div class="dashboard-layout-popup">
    <div class="popup-overlay" id="popup1"></div>
    <div class="popup-wrapper" id="wrapper1">
      <div class="popup-title">
        <h3>íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°</h3>
        <input type="hidden" id="searchExcelType" value="">
        <a onclick="NewClose()" title="íŒì—…ë‹«ê¸°" class="btn-popup-close">
          <img src="/images/icon/btn-popup-close.svg" alt="ë‹«ê¸°">
        </a>
      </div>
      <div class="popup-contents">
        <form id="searchExcelForm" autocomplete="off">
          <div class="table-wrap">
            <table class="view-table" id="selectedData" style="max-height: 740px;">
              <caption>íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°</caption>
              <colgroup>
                <col class="wp20">
                <col class="wauto">
                <col class="wp20">
                <col class="wauto">
              </colgroup>
              <tbody>
              <tr >
                <!--                <th>ì „í‘œ ë³´ê¸°</th>-->
                <th>ì‹œì‘ì¼</th>
                <td colspan="">
                  <input type="date">
                </td>
                <th>ì¢…ë£Œì¼</th>
                <td colspan="">
                  <input type="date">
                </td>
                <td>
                  <button type="button" id="searchExcelBtn" style="background-color: #0a68b4; color: #FFFFFF; width: 100% " onclick="modifyData()">ì¡°íšŒ</button>
                </td>
              </tr>
              <tr>
                <td colspan="5">
                  <div id="pdfWrapper" style="display: flex;">
                    <div id="pdfView" class="tab-item wp100" style="display: block;">
                      <div id="pdfContainer" style="
                              width: 100%;
                              height: auto;
                              padding: 10px;
                              background: #f8f9fa;
                              overflow-y: auto;
                              max-height: 500px;">
                        <!-- PDF í˜ì´ì§€ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                        <div id="loadingSpinner" style="display: none;">
                          <div class="spinner"></div>
                          <p>PDFë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </form>
      </div>
      <div class="popup-button">
        <button type="button" class="btn-navy btn-reject" onclick="downloadFile('reject')">ë‹¤ìš´ë¡œë“œ</button>
        <button type="button" class="btn-popup-close" onclick="NewClose()">ì¢…ë£Œ</button>
      </div>
    </div>
  </div>
</th:block>

<th:block layout:fragment="scripts">
  <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
  <script type="text/javascript">

    var theGrid;
    var viewdata1;
    let SelectItem;
    let csrfToken = $("[name=_csrf]").val();

    // document.readyState === 'complete' ? init() : window.onload = init;

    // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
    const date = new Date();
    date.setHours(date.getHours() + 9); // UTC+9ë¡œ í•œêµ­ ì‹œê°„ ì„¤ì •
    const today = date.toISOString().split('T')[0];

    // í˜„ì¬ ë…„ë„ì™€ ì›”ì„ ê°€ì ¸ì˜µë‹ˆë‹¤
    const currentYear = date.getFullYear();
    const currentMonth = (date.getMonth() + 1).toString().padStart(2, '0'); // 1ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1 ì²˜ë¦¬

    // ì´ë²ˆ ë‹¬ 1ì¼ì„ ì„¤ì •
    const firstDayOfMonth = `${currentYear}-${currentMonth}-01`;

    // input ê°’ ì„¤ì •
    document.getElementById('startDate').value = firstDayOfMonth;
    document.getElementById('endDate').value = today;

    $(document).ready(function () {
      // ì¶œê³  ì§„í–‰êµ¬ë¶„ select option ë°”ì¸ë“œ
      AjaxUtil.fillSelectOptions($('#searchChulflag'), 'system_code', 'all', false, 'delivery_type');
      fetchListData();
    });
    // ì£¼ë¬¸ì¶œê³  ê·¸ë¦¬ë“œ
    function fetchListData(saupnum) {
      let data2 = [];
      const transformedData = []; // ë³€í™˜ëœ ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´
      $.ajax({
        url: '/api/request/request/order_read',
        type: 'GET',
        data: {
          'saupnum': saupnum,
          'saupnumHidden': $('#saupnumHidden').val(),
          'search_startDate': $('#startDate').val(),
          'search_endDate': $('#endDate').val(),
          'search_chulflag': $('#searchChulflag').val(), // ì§„í–‰êµ¬ë¶„
          'search_comnm': $('#searchComnm').val() // í˜„ì¥ëª…
        },
        async: false,
        success: function (data) {
          data2 = data.data;
          data2.forEach(item => {
            if (item.CHULFLAG !== undefined && item.CHULFLAG !== null) {
              item.CHULFLAG = Number(item.CHULFLAG);
            }
          });
        }
      })
      // bd_detailsë¥¼ íŒŒì‹±í•˜ì—¬ ë°°ì—´ë¡œ ë³€í™˜
      // bd_detailsê°€ ìœ íš¨í•œ JSON ë¬¸ìì—´ì¼ ë•Œë§Œ íŒŒì‹±

      const seenReqnum = new Set(); // reqnumì„ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µì„ í™•ì¸
      if (data2.length < 12){
        while (data2.length < 12) {
          data2.push({'CHULFLAG' : null});
        }
      }
      viewdata1 = new wijmo.collections.CollectionView(data2); // ë³€í™˜ëœ ë°ì´í„°ë¥¼ CollectionViewë¡œ ë³€í™˜
      if (!theGrid) {
        // ë°ì´í„° ê·¸ë¦¬ë“œì— ë°”ì¸ë”©
        theGrid = new wijmo.grid.FlexGrid('#theGrid', {
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: false,
          selectionMode: wijmo.grid.SelectionMode.Row,
          columns: [
            {binding: 'CHULFLAG', header: 'ìì¬ì¶œê³ ', width: '*', align: 'center', dataType: wijmo.DataType.Boolean},
            {binding: 'CHULDATE', header: 'ì¶œí•˜ì¼ì', width: '*', align: 'center'},
            {binding: 'ACTNM', header: 'í˜„ì¥ëª…', width: '*', align: 'center'},
            {binding: 'PNAME', header: 'í’ˆëª…', width: '*', align: 'center'},
            {binding: 'PSIZE', header: 'ê·œê²©', width: '*', align: 'center'},
            {binding: 'PUNIT', header: 'ë‹¨ìœ„', width: '*', align: 'right'},
            {binding: 'PQTY', header: 'ìˆ˜ëŸ‰', width: '*', align: 'right'},
            {binding: 'PUAMT', header: 'ë‹¨ê°€', width: '*', align: 'right'},
            {binding: 'PAMT', header: 'ê¸ˆì•¡', width: '*', align: 'right'},
          ],
          itemsSource: viewdata1,
        });
        theGrid.formatItem.addHandler(function (s, e) {
          // í—¤ë”ë¥¼ ì¤‘ì•™ ì •ë ¬í•˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
          if (e.panel === s.columnHeaders) {
            e.cell.style.textAlign = 'center';
          }
          // CHULFLAG ì»¬ëŸ¼ì˜ ì…€ì—ì„œ ê°’ì´ nullì¼ ê²½ìš° ì²´í¬ë°•ìŠ¤ ìˆ¨ê¹€
          if (e.panel === s.cells) {
            var col = s.columns[e.col];
            if (col.binding === 'CHULFLAG') {
              var item = s.rows[e.row].dataItem;
              if (item && item.CHULFLAG === null) {
                e.cell.innerHTML = ''; // ì…€ì„ ë¹„ì›€ (ì²´í¬ë°•ìŠ¤ ì‚­ì œ)
              }
            }
          }
        });
        // í¸ì§‘ í—ˆìš© ì œì–´ (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€)
        theGrid.beginningEdit.addHandler(function(s, e) {
          // ì»¬ëŸ¼ ì´ë¦„ì´ 'CHULFLAG'ê°€ ì•„ë‹ˆë©´ í¸ì§‘ ë§‰ê¸°
          var col = s.columns[e.col];
          if (col.binding !== 'CHULFLAG') {
            e.cancel = true; // í¸ì§‘ ì·¨ì†Œ!
          }
        });
        // FlexGridì˜ ìµœëŒ€ ë†’ì´ë¥¼ ì œí•œí•˜ì—¬ ìŠ¤í¬ë¡¤ë°”ë¥¼ í™œì„±í™”
        theGrid.hostElement.style.maxHeight = '650px'; // ì•½ 12ê°œì˜ í–‰ ë†’ì´ì— ë§ê²Œ ì„¤ì •
        theGrid.hostElement.style.overflowY = 'auto';
        // ì„ íƒì´ ë³€ê²½ë  ë•Œ, í˜„ì¬ í•­ëª© ì—…ë°ì´íŠ¸
        theGrid.rowHeaders.columns.splice(0, 1);  //ë§¨ ì•ì— í—¤ë”ë¶€ë¶„ ì—†ì• ê¸°
        new FlexGridContextMenu(theGrid);
        window.downloadFileName = 'ì£¼ë¬¸ë“±ë¡ ì²¨ë¶€íŒŒì¼';
      } else {
        // ì´ë¯¸ FlexGridì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°, ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸
        theGrid.itemsSource = viewdata1;
      }
    }

    // í”„ë¡ íŠ¸ì—”ë“œ JavaScript PDF ë Œë”ë§ (modifyData + showPdf í†µí•©)
    function modifyData() {
      const container = document.getElementById("pdfContainer");
      const spinner = document.getElementById("loadingSpinner");

      // âœ… ì´ì „ PDF ì œê±°
      container.querySelectorAll("canvas").forEach(canvas => canvas.remove());

      // âœ… ìŠ¤í”¼ë„ˆ í‘œì‹œ (PDF ì „ì—)
      spinner.style.display = "flex";
      const url = `/api/request/request/readVacFile?appnum=${encodeURIComponent(rowData.appnum)}`;

      spinner.style.display = "flex"; // ìŠ¤í”¼ë„ˆ ë³´ì´ê¸°

      fetch(url)
              .then(res => res.blob())
              .then(blob => {
                const blobURL = URL.createObjectURL(blob);
                renderPdf(blobURL);
              })
              .catch(() => {
                spinner.style.display = "none"; // ì˜¤ë¥˜ ì‹œ ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
                container.innerHTML = "<p style='color:red;'>íœ´ê°€ì„œ ì–‘ì‹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
              });
    }
    function renderPdf(url) {
      const container = document.getElementById("pdfContainer");
      const spinner = document.getElementById("loadingSpinner");
      // PDF ë‚´ìš©(canvas)ë§Œ ì§€ìš°ê³  ìŠ¤í”¼ë„ˆëŠ” ìœ ì§€
      Array.from(container.querySelectorAll("canvas")).forEach(canvas => canvas.remove());
      spinner.style.display = "flex";

      pdfjsLib.getDocument({ url }).promise.then(pdf => {
        spinner.style.display = "none"; // ì„±ê³µ ì‹œ ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          pdf.getPage(pageNum).then(page => {
            const viewport = page.getViewport({ scale: 1.3 });
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");

            canvas.width = viewport.width;
            canvas.height = viewport.height;
            container.appendChild(canvas);

            page.render({
              canvasContext: context,
              viewport: viewport
            });
          });
        }
      }).catch(error => {
        spinner.style.display = "none";
        console.error("âŒ PDF ë Œë”ë§ ì˜¤ë¥˜:", error);
        alert("PDFë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      });
    }
    function NewSave() {
      let popup = document.getElementById('popup1');
      let wrapper = document.getElementById('wrapper1');

      const appgubun = $('#appgubun').val();
      console.log("ğŸ“Œ íŒì—… ì—´ê¸° - appgubun:", appgubun);  // ë¡œê·¸ë¡œ í™•ì¸

      popup.style.display = 'block';
      wrapper.style.display = 'block';
    }
    // ì¶œí•˜ ë° ì¸ìˆ˜í™•ì¸ì„œ í´ë¦­ ë©”ì„œë“œ
    function deliveryDoc(){
      NewSave(); // íŒì—… ì—´ê¸°
      document.getElementById('searchExcelType').value = 'delivery';
    }
    // ê±°ë˜ëª…ì„¸ì„œ í´ë¦­ ë©”ì„œë“œ
    function provDoc(){
      NewSave(); // íŒì—… ì—´ê¸°
      document.getElementById('searchExcelType').value = 'prov';
    }
    // ìì¬ì¶œê³  update ë©”ì„œë“œ
    function deliverySave(){
      $.ajax({
        url: '/api/request/request/saveDelivery',
        type: 'GET',
        data: {
          'search_comnm': $('#searchComnm').val() // í˜„ì¥ëª…
        },
        async: false,
        success: function (data) {
          data2 = data.data;
          data2.forEach(item => {
            if (item.CHULFLAG !== undefined && item.CHULFLAG !== null) {
              item.CHULFLAG = Number(item.CHULFLAG);
            }
          });
        }
      })
    }
    // ì—‘ì…€íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° íŒì—… ë‹«ê¸° ë©”ì„œë“œ
    function NewClose() {
      // íŒì—… ë‹«ê¸°
      let popup = document.getElementById('popup1');
      let wrapper = document.getElementById('wrapper1');
      let spinner = document.getElementById('loadingSpinner');
      popup.style.display = 'none';
      wrapper.style.display = 'none';
      spinner.style.display = 'none';
    }
    // ì—‘ì…€íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë©”ì„œë“œ
    function downloadFile() {

    }
  </script>
</th:block>
</html>

