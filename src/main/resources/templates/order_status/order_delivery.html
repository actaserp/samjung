<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>
<th:block layout:fragment="content">

  <!--- (레이아웃) Contents 영역 -->
  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>주문 출고</h2>
        <!--                <a href="#" title="북마크" class="bookmark toggle">-->
        <!--                    내메뉴-->
        <!--                </a>-->
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
        <li>주문 현황</li>
        <li>주문 출고</li>
      </ul>
    </div>
    <!-- Select -->
    <!--       주문등록 탭 종료   / 주문 의뢰현황 시작       -->
    <!-- Section -->
    <section class="tab-item" id="tab2" style="height: 832px;">
      <div class="section-top">
        <div class="search-wrap">
          <dl>
            <dt>
              주문일자<span class="eq">*</span>
            </dt>
            <dd>
              <ul class="date-box">
                <li>
                  <input type="date" id="startDate" name="startDate">
                  <label for="startDate" class="hide">시작일</label>
                </li>
                ~
                <li>
                  <input type="date" id="endDate" name="endDate">
                  <label for="endDate" class="hide">종료일</label>
                </li>
              </ul>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="searchComnm">
                현장명<span class="eq">*</span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <input type="text" id="searchComnm" name="searchComnm" class="input-srch"
                       placeholder="현장명" style="border-radius: 5px;">
                <!--                                        <a href="#a" class="btn-srch" title="검색" onclick="searchData()"></a>-->
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="searchChulflag">
                진행구분<span class="eq">*</span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <select id="searchChulflag" name="searchChulflag" style="border-radius: 5px 5px 5px 5px;">
                  <option value=""></option>
                </select>
                <!--                                        <a href="#a" class="btn-srch" title="검색" onclick="searchData()"></a>-->
              </div>
            </dd>
          </dl>
          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="검색" id="searchButton1" onclick="fetchListData()">
                  <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                  <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                  검색
                </a>
              </li>
            </dd>
          </dl>
          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="저장" id="deliverySave" onclick="deliverySave()">
                  <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                  <img src="/images/icon/ico-save.svg" alt="저장 아이콘">
                  저장
                </a>
              </li>
            </dd>
          </dl>
          <dl>
            <dd>
              <li>
                <button id="deliveryBtn" onclick="deliveryDoc()">출하 및 인수확인서</button>
              </li>
            </dd>
          </dl>
          <dl>
            <dd>
              <li>
                <button id="provBtn" onclick="provDoc()">거래명세서</button>
              </li>
            </dd>
          </dl>
        </div>
      </div>
      <div class="container-fluid">
        <p id="selectedItem"></p>
        <div id="theGrid" style="max-height: 714px"></div>
      </div>
    </section>
  </div> <!--//layout-contents end -->
  <footer style="margin-top:5px;">
    <p>Copyrightⓒ 0000 corp. All rights reserved.</p>
  </footer>
  <div style="height: 10px"></div>
  <div class="dashboard-layout-popup">
    <div class="popup-overlay" id="popup1"></div>
    <div class="popup-wrapper" id="wrapper1">
      <div class="popup-title">
        <h3>파일 미리보기</h3>
        <input type="hidden" id="searchExcelType" value="">
        <a onclick="NewClose()" title="팝업닫기" class="btn-popup-close">
          <img src="/images/icon/btn-popup-close.svg" alt="닫기">
        </a>
      </div>
      <div class="popup-contents">
        <form id="searchExcelForm" autocomplete="off">
          <div class="table-wrap">
            <table class="view-table" id="selectedData" style="max-height: 740px;">
              <caption>파일 미리보기</caption>
              <colgroup>
                <col class="wp20">
                <col class="wauto">
                <col class="wp20">
                <col class="wauto">
              </colgroup>
              <tbody>
              <tr >
                <!--                <th>전표 보기</th>-->
                <th>시작일</th>
                <td colspan="">
                  <input type="date">
                </td>
                <th>종료일</th>
                <td colspan="">
                  <input type="date">
                </td>
                <td>
                  <button type="button" id="searchExcelBtn" style="background-color: #0a68b4; color: #FFFFFF; width: 100% " onclick="modifyData()">조회</button>
                </td>
              </tr>
              <tr>
                <td colspan="5">
                  <div id="pdfWrapper" style="display: flex;">
                    <div id="pdfView" class="tab-item wp100" style="display: block;">
                      <div id="pdfContainer" style="
                              width: 100%;
                              height: auto;
                              padding: 10px;
                              background: #f8f9fa;
                              overflow-y: auto;
                              max-height: 500px;">
                        <!-- PDF 페이지가 동적으로 추가됩니다. -->
                        <div id="loadingSpinner" style="display: none;">
                          <div class="spinner"></div>
                          <p>PDF를 불러오는 중입니다...</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </form>
      </div>
      <div class="popup-button">
        <button type="button" class="btn-navy btn-reject" onclick="downloadFile('reject')">다운로드</button>
        <button type="button" class="btn-popup-close" onclick="NewClose()">종료</button>
      </div>
    </div>
  </div>
</th:block>

<th:block layout:fragment="scripts">
  <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
  <script type="text/javascript">

    var theGrid;
    var viewdata1;
    let SelectItem;
    let csrfToken = $("[name=_csrf]").val();

    // document.readyState === 'complete' ? init() : window.onload = init;

    // 오늘 날짜 설정
    const date = new Date();
    date.setHours(date.getHours() + 9); // UTC+9로 한국 시간 설정
    const today = date.toISOString().split('T')[0];

    // 현재 년도와 월을 가져옵니다
    const currentYear = date.getFullYear();
    const currentMonth = (date.getMonth() + 1).toString().padStart(2, '0'); // 1월은 0부터 시작하므로 +1 처리

    // 이번 달 1일을 설정
    const firstDayOfMonth = `${currentYear}-${currentMonth}-01`;

    // input 값 설정
    document.getElementById('startDate').value = firstDayOfMonth;
    document.getElementById('endDate').value = today;

    $(document).ready(function () {
      // 출고 진행구분 select option 바인드
      AjaxUtil.fillSelectOptions($('#searchChulflag'), 'system_code', 'all', false, 'delivery_type');
      fetchListData();
    });
    // 주문출고 그리드
    function fetchListData(saupnum) {
      let data2 = [];
      const transformedData = []; // 변환된 데이터를 저장할 배열
      $.ajax({
        url: '/api/request/request/order_read',
        type: 'GET',
        data: {
          'saupnum': saupnum,
          'saupnumHidden': $('#saupnumHidden').val(),
          'search_startDate': $('#startDate').val(),
          'search_endDate': $('#endDate').val(),
          'search_chulflag': $('#searchChulflag').val(), // 진행구분
          'search_comnm': $('#searchComnm').val() // 현장명
        },
        async: false,
        success: function (data) {
          data2 = data.data;
          data2.forEach(item => {
            if (item.CHULFLAG !== undefined && item.CHULFLAG !== null) {
              item.CHULFLAG = Number(item.CHULFLAG);
            }
          });
        }
      })
      // bd_details를 파싱하여 배열로 변환
      // bd_details가 유효한 JSON 문자열일 때만 파싱

      const seenReqnum = new Set(); // reqnum을 기준으로 중복을 확인
      if (data2.length < 12){
        while (data2.length < 12) {
          data2.push({'CHULFLAG' : null});
        }
      }
      viewdata1 = new wijmo.collections.CollectionView(data2); // 변환된 데이터를 CollectionView로 변환
      if (!theGrid) {
        // 데이터 그리드에 바인딩
        theGrid = new wijmo.grid.FlexGrid('#theGrid', {
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: false,
          selectionMode: wijmo.grid.SelectionMode.Row,
          columns: [
            {binding: 'CHULFLAG', header: '자재출고', width: '*', align: 'center', dataType: wijmo.DataType.Boolean},
            {binding: 'CHULDATE', header: '출하일자', width: '*', align: 'center'},
            {binding: 'ACTNM', header: '현장명', width: '*', align: 'center'},
            {binding: 'PNAME', header: '품명', width: '*', align: 'center'},
            {binding: 'PSIZE', header: '규격', width: '*', align: 'center'},
            {binding: 'PUNIT', header: '단위', width: '*', align: 'right'},
            {binding: 'PQTY', header: '수량', width: '*', align: 'right'},
            {binding: 'PUAMT', header: '단가', width: '*', align: 'right'},
            {binding: 'PAMT', header: '금액', width: '*', align: 'right'},
          ],
          itemsSource: viewdata1,
        });
        theGrid.formatItem.addHandler(function (s, e) {
          // 헤더를 중앙 정렬하는 이벤트 핸들러
          if (e.panel === s.columnHeaders) {
            e.cell.style.textAlign = 'center';
          }
          // CHULFLAG 컬럼의 셀에서 값이 null일 경우 체크박스 숨김
          if (e.panel === s.cells) {
            var col = s.columns[e.col];
            if (col.binding === 'CHULFLAG') {
              var item = s.rows[e.row].dataItem;
              if (item && item.CHULFLAG === null) {
                e.cell.innerHTML = ''; // 셀을 비움 (체크박스 삭제)
              }
            }
          }
        });
        // 편집 허용 제어 (이벤트 핸들러 추가)
        theGrid.beginningEdit.addHandler(function(s, e) {
          // 컬럼 이름이 'CHULFLAG'가 아니면 편집 막기
          var col = s.columns[e.col];
          if (col.binding !== 'CHULFLAG') {
            e.cancel = true; // 편집 취소!
          }
        });
        // FlexGrid의 최대 높이를 제한하여 스크롤바를 활성화
        theGrid.hostElement.style.maxHeight = '650px'; // 약 12개의 행 높이에 맞게 설정
        theGrid.hostElement.style.overflowY = 'auto';
        // 선택이 변경될 때, 현재 항목 업데이트
        theGrid.rowHeaders.columns.splice(0, 1);  //맨 앞에 헤더부분 없애기
        new FlexGridContextMenu(theGrid);
        window.downloadFileName = '주문등록 첨부파일';
      } else {
        // 이미 FlexGrid이 존재하는 경우, 데이터만 업데이트
        theGrid.itemsSource = viewdata1;
      }
    }

    // 프론트엔드 JavaScript PDF 렌더링 (modifyData + showPdf 통합)
    function modifyData() {
      const container = document.getElementById("pdfContainer");
      const spinner = document.getElementById("loadingSpinner");

      // ✅ 이전 PDF 제거
      container.querySelectorAll("canvas").forEach(canvas => canvas.remove());

      // ✅ 스피너 표시 (PDF 전에)
      spinner.style.display = "flex";
      const url = `/api/request/request/readVacFile?appnum=${encodeURIComponent(rowData.appnum)}`;

      spinner.style.display = "flex"; // 스피너 보이기

      fetch(url)
              .then(res => res.blob())
              .then(blob => {
                const blobURL = URL.createObjectURL(blob);
                renderPdf(blobURL);
              })
              .catch(() => {
                spinner.style.display = "none"; // 오류 시 스피너 숨기기
                container.innerHTML = "<p style='color:red;'>휴가서 양식을 불러올 수 없습니다.</p>";
              });
    }
    function renderPdf(url) {
      const container = document.getElementById("pdfContainer");
      const spinner = document.getElementById("loadingSpinner");
      // PDF 내용(canvas)만 지우고 스피너는 유지
      Array.from(container.querySelectorAll("canvas")).forEach(canvas => canvas.remove());
      spinner.style.display = "flex";

      pdfjsLib.getDocument({ url }).promise.then(pdf => {
        spinner.style.display = "none"; // 성공 시 스피너 숨기기
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          pdf.getPage(pageNum).then(page => {
            const viewport = page.getViewport({ scale: 1.3 });
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");

            canvas.width = viewport.width;
            canvas.height = viewport.height;
            container.appendChild(canvas);

            page.render({
              canvasContext: context,
              viewport: viewport
            });
          });
        }
      }).catch(error => {
        spinner.style.display = "none";
        console.error("❌ PDF 렌더링 오류:", error);
        alert("PDF를 표시할 수 없습니다.");
      });
    }
    function NewSave() {
      let popup = document.getElementById('popup1');
      let wrapper = document.getElementById('wrapper1');

      const appgubun = $('#appgubun').val();
      console.log("📌 팝업 열기 - appgubun:", appgubun);  // 로그로 확인

      popup.style.display = 'block';
      wrapper.style.display = 'block';
    }
    // 출하 및 인수확인서 클릭 메서드
    function deliveryDoc(){
      NewSave(); // 팝업 열기
      document.getElementById('searchExcelType').value = 'delivery';
    }
    // 거래명세서 클릭 메서드
    function provDoc(){
      NewSave(); // 팝업 열기
      document.getElementById('searchExcelType').value = 'prov';
    }
    // 자재출고 update 메서드
    function deliverySave(){
      $.ajax({
        url: '/api/request/request/saveDelivery',
        type: 'GET',
        data: {
          'search_comnm': $('#searchComnm').val() // 현장명
        },
        async: false,
        success: function (data) {
          data2 = data.data;
          data2.forEach(item => {
            if (item.CHULFLAG !== undefined && item.CHULFLAG !== null) {
              item.CHULFLAG = Number(item.CHULFLAG);
            }
          });
        }
      })
    }
    // 엑셀파일 미리보기 팝업 닫기 메서드
    function NewClose() {
      // 팝업 닫기
      let popup = document.getElementById('popup1');
      let wrapper = document.getElementById('wrapper1');
      let spinner = document.getElementById('loadingSpinner');
      popup.style.display = 'none';
      wrapper.style.display = 'none';
      spinner.style.display = 'none';
    }
    // 엑셀파일 다운로드 메서드
    function downloadFile() {

    }
  </script>
</th:block>
</html>

