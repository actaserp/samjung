<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>
    .container-fluid {
        padding: 20px;
    }

    .chartModal {
        display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê²¨ì§ */
        position: fixed;
        z-index: 10000; /* z-index ê°’ì„ ë†’ê²Œ ì„¤ì •í•˜ì—¬ ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ í•¨ */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* ë°°ê²½ì„ ë°˜íˆ¬ëª…í•˜ê²Œ ì„¤ì • */
        overflow: auto;
    }

    .modal-content {
        position: absolute; /* absoluteë¡œ ì„¤ì •í•˜ì—¬ í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜ */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); /* í™”ë©´ ì¤‘ì•™ ì •ë ¬ */
        background-color: #fff;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
    }

    .chart-container {
        position: relative; /* ë¶€ëª¨ ìš”ì†Œì— ìœ„ì¹˜ ê³ ì • */
        width: 100%; /* ì›í•˜ëŠ” ë„ˆë¹„ */
        height: 250px; /* ê³ ì •ëœ ë†’ì´ */
        overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™” */
        overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë¹„í™œì„±í™” */
        border: 1px solid #ccc; /* í…Œë‘ë¦¬ ì¶”ê°€ (ì„ íƒ ì‚¬í•­) */
        padding: 10px; /* ì—¬ë°± ì¶”ê°€ (ì„ íƒ ì‚¬í•­) */
    }
    .chart-container span {
        position: absolute; /* âœ… ì°¨íŠ¸ ìœ„ì— ë°°ì¹˜ */
        top: 10px; /* âœ… ìœ„ì¹˜ ì¡°ì • */
        right: 10px;
        cursor: pointer;
        color: rgb(179, 179, 179);
        font-size: 24px; /* âœ… ì•„ì´ì½˜ í¬ê¸° ì¡°ì • */
        z-index: 10; /* âœ… ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— ë°°ì¹˜ */
    }
</style>
<th:block layout:fragment="content">
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>ì§„í–‰ í˜„í™©</h2><a id="toggleButton" onclick="toggleSearchWrap()"><img src="/images/icon/ico-down.png"
                                                                                     alt="ì•ŒëŒ ì•„ì´ì½˜"></a>
                <!--<a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ë©”ë‰´
                </a>-->
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ì£¼ë¬¸ í˜„í™©</li>
            </ul>
        </div>
        <div class="search-wrap" id="searchWrap" style="display: none; padding-top:10px">
            <ul>
                <li>
                    <select title="ì‚¬ì—…ì¥" id="search_spjangcd" name="search_spjangcd"
                            onchange="init()">
                        <option value="" hidden selected disabled>ì„ íƒ</option>
                        <option value="ZZ">ì„±ìš°ì—ìŠ¤í”¼(ì£¼)</option>
                        <option value="PP">ì„±ìš°í”¼ì•¤ë¹„(ì£¼)</option>
                        <!-- ì§€ì—­ ì˜µì…˜ì„ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì±„ì›€ -->
                    </select>
                </li>
            </ul>
        </div>
        <!-- Select -->
        <div class="tab-contents">
            <section class="tab-item" style="height: 900px; overflow: hidden;">
                <div class="section-top">
                    <div class="search-wrap">
                        <dl>
                            <dt>
                                ì¡°íšŒê¸°ê°„<span class="eq">*</span>
                                <img src="/images/icon/exclamation/exclamation-circle.svg"
                                     class="zoom-img" style="margin-left: 5px"
                                     onclick="openPopup('https://foms.atlassian.net/wiki/external/Yjk4ODJlMzgxYWI5NDcwMjhlYWRhYzkwMzgxNTcyNjc')" alt="ë„ì›€ë§">
                            </dt>
                            <dd>
                                <ul class="date-box">
                                    <li>
                                        <input type="date" id="startDate" name="startDate">
                                        <label for="startDate" class="hide">ì‹œì‘ì¼</label>
                                    </li>
                                    <li>
                                        <input type="date" id="endDate" name="endDate">
                                        <label for="endDate" class="hide">ì¢…ë£Œì¼</label>
                                    </li>
                                </ul>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="searchtketnm">
                                    ì§„í–‰êµ¬ë¶„<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                        <select id="searchtketnm" name="searchtketnm">
                                            <option value="all"></option>
                                        </select>
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="searchCltnm">
                                    ì—…ì²´ëª…<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input type="text" id="searchCltnm" name="searchCltnm" class="input-srch"
                                           placeholder="ì—…ì²´ëª…" style="border-radius: 5px;">
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>
                                <label for="searchTitle">
                                    ì œëª©<span class="eq">*</span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input type="text" id="searchTitle" name="searchTitle" class="input-srch"
                                           placeholder="ì œëª©" style="border-radius: 5px;">
                                </div>
                            </dd>
                        </dl>
                        <dl>
                            <dt>&nbsp;</dt>
                            <dd>
                                <li>
                                    <a class="btn btn-delete" title="ê²€ìƒ‰" id="searchButton" onclick="searchButton()">
                                        <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                        <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                        ê²€ìƒ‰
                                    </a>
                                </li>
                            </dd>
                        </dl>
                    </div>
                </div>
                <div class="container-fluid">
                    <div class="chart-container">
                        <canvas id="myChart" width="400" height="115px"></canvas>
                    </div>
                    <span class="material-symbols-outlined" onclick="openModal()">zoom_out_map</span>
                    <div>
                        <div>
                            <p id="selectedItem"></p>
                            <div id="theGrid" style="max-height:319px"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div> <!--//tab-wrap end-->
    </div> <!--//layout-contents end -->
    <footer>
        <p>Copyrightâ“’ 0000 corp. All rights reserved.</p>
    </footer>

</th:block>

<div id="chartModal" class="modal" style="opacity:100">
    <div class="modal-content">
        <span class="close">&times;</span>
        <canvas id="modalChartHolder" style="width: 1250px; height: 490px; display: block; box-sizing: border-box;"
                width="1250" height="490"></canvas>
    </div>
</div>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript">
        var theGrid;

        document.readyState === 'complete' ? init() : window.onload = init;
        let isBindSpjangcdCalled = false;

        <!-- ì´ˆë°˜ í˜ì´ì§€ ì§„ì…ì‹œ ê·¸ë¦¬ë“œ ë°”ì¸ë”© ë-->
        function init() {
            fetchListData();
            loadChartData();
            if (!isBindSpjangcdCalled) {
                bindSpjangcd();
                isBindSpjangcdCalled = true; // í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
            }
          document.getElementById('search_spjangcd').addEventListener('change', searchButton);
        }

        $(document).ready(function () {
            // í˜„ì¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth(); // 0ë¶€í„° ì‹œì‘í•˜ëŠ” ì›”(0 = 1ì›”)

            // ì‹œì‘ì¼: ì´ë²ˆ ë‹¬ 1ì¼
            const startOfMonth = new Date(year, month, 1);
            const startMonthFormatted = startOfMonth.getFullYear() + '-' + String(startOfMonth.getMonth() + 1).padStart(2, '0') + '-' + String(startOfMonth.getDate()).padStart(2, '0');
            $('#startDate').val(startMonthFormatted);

            // ì¢…ë£Œì¼: ì˜¤ëŠ˜ ë‚ ì§œ
            const todayFormatted = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            $('#endDate').val(todayFormatted);
        });


        function fetchListData() {
            let data2 = [];
            const spjangcd = document.getElementById('search_spjangcd').value;
            const startDate = document.getElementById('startDate').value || "";
            const endDate = document.getElementById('endDate').value || "";
            const searchCltnm = document.getElementById('searchCltnm').value.trim() || "";
            const searchtketnm = document.getElementById('searchtketnm').value || "";
            const searchTitle = document.getElementById('searchTitle')?.value || "";

            const queryParams = {
                search_spjangcd: spjangcd,
                startDate: startDate,
                endDate: endDate,
                searchCltnm: searchCltnm,
                searchtketnm: searchtketnm,
                searchTitle: searchTitle
            };

            // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            $.ajax({
                url: '/api/ProgressStatus/read',
                type: 'GET',
                data: queryParams,
                async: false,
                success: function (response) {
                    //console.log("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° :", response);
                    // ì‘ë‹µì´ ì˜¬ë°”ë¥´ê²Œ ë„ì°©í–ˆê³ , data ì†ì„±ì´ ë°°ì—´ì¸ì§€ í™•ì¸
                    if (response && Array.isArray(response.data)) {
                        console.log("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ëª©ë¡:", response.data); //ì‹¤ì œ ë°ì´í„° í™•ì¸
                    }
                    if (response && Array.isArray(response.data)) {
                        data2 = response.data.map((item, index) => ({
                            ...item,
                            rownum: index + 1
                        }));
                    }
                },
                error: function () {
                    console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
            // ë°ì´í„° ê°œìˆ˜ê°€ 10ê°œ ë¯¸ë§Œì¼ ê²½ìš° ë¹ˆ ë°ì´í„° í–‰ ì¶”ê°€
            while (data2.length < 10) {
                data2.push({
                    rownum: data2.length + 1,
                    reqdate: '',
                    ordflag_display:'',
                    ordflag: '',
                    cltnm: '',
                    manager: '',
                    telnum: '',
                    orderprice: '',
                    deldate: '',
                    remark: ''
                });
            }

            viewdata = new wijmo.collections.CollectionView(data2);

            if (!theGrid) {
                // ë°ì´í„° ê·¸ë¦¬ë“œì— ë°”ì¸ë”©
                theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true, // ì „ì²´ ì½ê¸° ì „ìš©
                    columns: [
                        {binding: 'rownum', header: 'ìˆœë²ˆ', width: 80, align: 'center'},
                        {binding: 'reqdate', header: 'ì£¼ë¬¸ì¼ì', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'cltnm', header: 'ì—…ì²´ëª…', width: '*', minWidth: 100, align: 'left'},
                        {binding: 'ordflag_display', header: 'ì§„í–‰êµ¬ë¶„', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'remark', header: 'ì œëª©(ë©”ëª¨)', width: '*', minWidth: 400, align: 'left'},
                        {binding: 'perid', header: 'ë‹´ë‹¹ì', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'telno', header: 'ì—°ë½ì²˜', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'orderprice', header: 'ê¸ˆì•¡', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'deldate', header: 'ì¶œê³ ì¼ì', width: '*', minWidth: 100, align: 'center'},
                    ],
                    itemsSource: viewdata
                });
                theGrid.rowHeaders.columns.splice(0, 1);
                new FlexGridContextMenu(theGrid);
                window.downloadFileName = 'ì£¼ë¬¸ì§„í–‰ í˜„í™©';
            } else {
                // ì´ë¯¸ FlexGridê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°, ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸
                theGrid.itemsSource = viewdata;
            }
        }

        function loadChartData() {
            const spjangcd = document.getElementById('search_spjangcd').value;
            const startDate = document.getElementById('startDate').value || "";
            const endDate = document.getElementById('endDate').value || "";
            const searchCltnm = document.getElementById('searchCltnm').value.trim() || "";
            const searchtketnm = document.getElementById('searchtketnm').value || "";
            const searchTitle = document.getElementById('searchTitle')?.value || "";

            const queryParams = {
                search_spjangcd: spjangcd,
                startDate: startDate,
                endDate: endDate,
                searchCltnm: searchCltnm,
                searchtketnm: searchtketnm,
                searchTitle: searchTitle
            };
            const urlParams = new URLSearchParams(queryParams).toString();

            $.ajax({
                url: `/api/ProgressStatus/getChartData2?${urlParams}`,
                method: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response.success && response.data && response.data.length > 0) {
                        // ğŸ“Œ ë°ì´í„° ê°€ê³µ: ì£¼ë¬¸ ìƒíƒœë³„ ê°œìˆ˜ ê³„ì‚°
                        const orderCounts = {
                            "ì£¼ë¬¸ì·¨ì†Œ": 0,
                            "ì£¼ë¬¸ë“±ë¡": 0,
                            "ì£¼ë¬¸í™•ì¸": 0,
                            "ì£¼ë¬¸í™•ì •": 0,
                            "ì œì‘ì§„í–‰": 0,
                            "ì¶œê³ ": 0
                        };

                        response.data.forEach(item => {
                            const status = stageMapping[item.ordflag] || "ê¸°íƒ€";
                            if (orderCounts[status] !== undefined) {
                                orderCounts[status]++;
                            }
                        });

                        // ğŸ“Œ ì´ ê±´ìˆ˜ ê³„ì‚°
                        const totalOrders = response.data.length;

                        // ğŸ“Œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                        initializeChart(orderCounts, totalOrders);
                    } else {
                        console.log(response.message || "ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        initializeChart({}, 0); // ë°ì´í„° ì—†ì„ ê²½ìš° ì´ˆê¸°í™”
                    }
                },
                error: function () {
                    console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                    initializeChart({}, 0);
                }
            });
        }
        // ìˆ«ì â†’ ê°’ ë§¤í•‘ ê°ì²´
        const stageMapping = {
            5: "ì£¼ë¬¸ì·¨ì†Œ",
            0: "ì£¼ë¬¸ë“±ë¡",
            1: "ì£¼ë¬¸í™•ì¸",
            2: "ì£¼ë¬¸í™•ì •",
            3: "ì œì‘ì§„í–‰",
            4: "ì¶œê³ ",

        };
        //ì°¨íŠ¸
        console.log(Chart.version); // ì½˜ì†”ì—ì„œ Chart.js ë²„ì „ì„ í™•ì¸

        $(document).ready(function () {
            initializeChart(function () {
                loadChartData(); // ì°¨íŠ¸ ì´ˆê¸°í™” í›„ ë°ì´í„° ë¡œë“œ
            });
        });

        window.openModal = function () {
            let chartElement = document.getElementById('myChart');

            // âœ… Chart.js ë°©ì‹ìœ¼ë¡œ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
            let chartInstance = Chart.getChart(chartElement);

            if (!chartInstance) {
                console.error("ì°¨íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                alert("ì°¨íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì°¨íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”."); // âœ… Alert.alert â†’ alert ì‚¬ìš©
                return;
            }

            let modal = $('#chartModal');
            modal.show();

            let modalChartHolder = $('#modalChartHolder')[0].getContext('2d');

            // âœ… ê¸°ì¡´ ëª¨ë‹¬ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ
            if (window.modalChartInstance) {
                window.modalChartInstance.destroy();
            }

            // âœ… ëª¨ë‹¬ ì°¨íŠ¸ ìƒì„± (ê¸°ì¡´ ì°¨íŠ¸ ë°ì´í„° ìœ ì§€)
            window.modalChartInstance = new Chart(modalChartHolder, {
                type: chartInstance.config.type,
                data: chartInstance.config.data,
                options: chartInstance.config.options
            });
        };
        $(document).on('click', '.close', function () {
            $('#chartModal').hide();
            if (window.modalChartInstance) {
                window.modalChartInstance.destroy();
            }
        });

        $(window).on('click', function (event) {
            if ($(event.target).is('#chartModal')) {
                $('#chartModal').hide();
                if (window.modalChartInstance) {
                    window.modalChartInstance.destroy();
                }
            }
        });

        function initializeChart(orderCounts = {}, totalOrders = 0) {
            const chartElement = document.getElementById('myChart');
            if (!chartElement) {
                console.error('Chart element not found!');
                return;
            }

            const ctx = chartElement.getContext('2d');

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            const existingChart = Chart.getChart(chartElement);
            if (existingChart) {
                existingChart.destroy();
            }

            // Xì¶• ë¼ë²¨
            const labels = ["ì£¼ë¬¸ì·¨ì†Œ", "ì£¼ë¬¸ë“±ë¡", "ì£¼ë¬¸í™•ì¸", "ì£¼ë¬¸í™•ì •", "ì œì‘ì§„í–‰", "ì¶œê³ "];

            // ì‹¤ì œ ë°ì´í„° (ë¹¨ê°„ìƒ‰)
            const coloredData = labels.map(label => orderCounts[label] || 0);

            // ë‚¨ì€ ë°ì´í„° (íšŒìƒ‰)
            const grayData = labels.map(label => totalOrders - (orderCounts[label] || 0));

            const data = {
                labels: labels,
                datasets: [
                    {
                        label: 'ê° ì§„í–‰ ê±´ìˆ˜',
                        data: coloredData,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.3)',
                            'rgba(255, 159, 64, 0.4)',
                            'rgba(255, 215, 0, 0.4)',
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(54, 162, 235, 0.4)',
                            'rgba(153, 102, 255, 0.2)'
                        ]
                    },
                    {
                        label: 'ì´ ê±´ìˆ˜',
                        data: grayData,
                        backgroundColor: 'rgba(200, 200, 200, 0.2)' // íšŒìƒ‰
                    }
                ]
            };

            // ì°¨íŠ¸ ì˜µì…˜
            const options = {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                       // display: false //ë¼ë²¨ ìˆ¨ê¸°ê¸°
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        max: totalOrders + 4 // Yì¶• ìµœëŒ€ê°’ì„ í˜„ì¬ ì´ ê°œìˆ˜ + 4
                    }
                }
            };

            // ì°¨íŠ¸ ìƒì„±
            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: options
            });
        }

        //ê²€ìƒ‰
        function searchButton() {
            // ì…ë ¥ëœ ê°’ ê°€ì ¸ì˜¤ê¸°
            const search_spjangcd = document.getElementById('search_spjangcd').value || "";
            const startDate = document.getElementById('startDate').value || "";
            const endDate = document.getElementById('endDate').value || "";
            const searchCltnm = document.getElementById('searchCltnm').value.trim() || "";
            const searchtketnm = document.getElementById('searchtketnm').value || "";
            const searchTitle = document.getElementById('searchTitle')?.value || "";

            // ê²€ìƒ‰ ìš”ì²­ ë°ì´í„° êµ¬ì„±
            const queryParams = {
                search_spjangcd,
                startDate,
                endDate,
                searchCltnm,
                searchtketnm,
                searchTitle
            };

            // ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ
            loadChartData(queryParams);
            fetchListData(queryParams);
        }

        // ì‚¬ì—…ì¥
        function bindSpjangcd() {
            $.ajax({
                url: '/api/dashboard2/bindSpjangcd',
                type: 'GET',
                async: false,
                success: function (data) {
                    data2 = data.data;
                    const selectElement = document.getElementById('search_spjangcd');
                    if (selectElement) {
                        selectElement.value = data2; // value ì†ì„±ìœ¼ë¡œ ì„ íƒ
                    }
                }
            })
        }

        function openPopup(url) {
            // ìƒˆ ì°½ ì—´ê¸°
            window.open(url, '_blank',
                'width=1040,height=1000,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes');
        }

        //ê³µí†µì½”ë“œ
        const selectConfigs = [
            { parentCode: 'ordflag', elementId: 'searchtketnm' },
        ];
        selectConfigs.forEach(config => {
            initializeSelect3({
                url: '/api/order_status/ordFlagType',
                params: { parentCode: config.parentCode },
                elementId: config.elementId,
                valueField: "code",
                textField: "value",
                includeAllOption: true, // "ì „ì²´" ì˜µì…˜ ì‚¬ìš©
            });
        });
    </script>
</th:block>
</html>